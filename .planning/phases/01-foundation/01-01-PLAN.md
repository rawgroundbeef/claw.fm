---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - pnpm-workspace.yaml
  - tsconfig.json
  - .gitignore
  - .npmrc
  - packages/shared/package.json
  - packages/shared/tsconfig.json
  - packages/shared/src/index.ts
  - api/package.json
  - api/tsconfig.json
  - api/wrangler.toml
  - api/src/index.ts
  - api/migrations/0001_tracks-schema.sql
autonomous: true

must_haves:
  truths:
    - "Running `pnpm install` at project root installs all workspace dependencies without errors"
    - "Running `wrangler dev` in api/ starts Hono and GET /health returns {status: ok}"
    - "D1 tracks table exists locally after applying migration with correct columns"
    - "Importing Track type from @claw/shared in api/ compiles without errors"
  artifacts:
    - path: "pnpm-workspace.yaml"
      provides: "Workspace root linking api, web, packages/*"
      contains: "packages:"
    - path: "packages/shared/src/index.ts"
      provides: "Track interface and shared types"
      exports: ["Track"]
    - path: "api/src/index.ts"
      provides: "Hono app with health endpoint and typed Bindings"
      exports: ["default"]
    - path: "api/wrangler.toml"
      provides: "Cloudflare Workers config with D1 and R2 bindings"
      contains: "d1_databases"
    - path: "api/migrations/0001_tracks-schema.sql"
      provides: "Tracks table DDL with indexes"
      contains: "CREATE TABLE tracks"
  key_links:
    - from: "api/src/index.ts"
      to: "@claw/shared"
      via: "workspace protocol import"
      pattern: "from '@claw/shared'"
    - from: "api/package.json"
      to: "packages/shared"
      via: "workspace:* dependency"
      pattern: '"@claw/shared":\\s*"workspace:\\*"'
    - from: "api/wrangler.toml"
      to: "D1 database"
      via: "binding declaration"
      pattern: 'binding = "DB"'
---

<objective>
Scaffold the pnpm monorepo, create the shared types package with the Track interface, and build the Hono API workspace with a health endpoint, D1 tracks schema migration, and R2 bucket binding.

Purpose: Establishes the project skeleton that every future phase builds on -- workspace root, shared types contract, and a running API with database schema.
Output: Working monorepo with `pnpm install` succeeding, `wrangler dev` serving /health, and D1 migration applied locally.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold monorepo root and shared types package</name>
  <files>
    package.json
    pnpm-workspace.yaml
    tsconfig.json
    .gitignore
    .npmrc
    packages/shared/package.json
    packages/shared/tsconfig.json
    packages/shared/src/index.ts
  </files>
  <action>
    Create the pnpm monorepo root and shared types package:

    1. Root `package.json`:
       - name: "claw-fm", private: true
       - scripts: {} (will be populated as workspaces are added)
       - No dependencies at root level

    2. `pnpm-workspace.yaml`:
       ```yaml
       packages:
         - 'api'
         - 'web'
         - 'packages/*'
       ```

    3. `.npmrc` with `shamefully-hoist=false` (enforce strict deps)

    4. Root `tsconfig.json`:
       - target: ES2022, module: ESNext, moduleResolution: bundler
       - strict: true, skipLibCheck: true
       - references to api, web, packages/shared (TypeScript project references for IDE)

    5. `.gitignore` -- add standard ignores:
       - node_modules, dist, .wrangler, .dev.vars, .env, .DS_Store
       - D1 local state: .wrangler/state/

    6. `packages/shared/package.json`:
       - name: "@claw/shared", private: true
       - main: "src/index.ts" (use TypeScript source directly -- no build step needed with workspace protocol)
       - types: "src/index.ts"

    7. `packages/shared/tsconfig.json`:
       - extends root tsconfig if applicable, or standalone strict config
       - include: ["src"]

    8. `packages/shared/src/index.ts` -- export the Track interface:
       ```typescript
       export interface Track {
         id: number
         title: string
         wallet: string
         duration: number
         fileUrl: string
         createdAt: number
         playCount: number
         tipWeight: number
       }

       export interface ApiResponse<T> {
         data?: T
         error?: string
       }

       export interface HealthResponse {
         status: 'ok'
         timestamp: number
       }
       ```

    Do NOT use TypeScript path aliases (e.g., "@/"). Use workspace protocol for cross-package imports.
    Do NOT add a build step for shared package -- consume TypeScript source directly via workspace protocol.
  </action>
  <verify>
    - `ls packages/shared/src/index.ts` exists
    - `cat pnpm-workspace.yaml` shows all three workspace entries
    - `cat packages/shared/package.json` shows name "@claw/shared"
  </verify>
  <done>
    Root monorepo config exists with pnpm workspaces, .gitignore, and tsconfig. Shared types package exports Track, ApiResponse, and HealthResponse interfaces.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Hono API workspace with health endpoint and D1/R2 bindings</name>
  <files>
    api/package.json
    api/tsconfig.json
    api/wrangler.toml
    api/src/index.ts
  </files>
  <action>
    Create the Cloudflare Workers + Hono API workspace:

    1. `api/package.json`:
       - name: "claw-fm-api", private: true
       - dependencies: hono, @claw/shared (workspace:*)
       - devDependencies: wrangler, @cloudflare/workers-types
       - scripts:
         - "dev": "wrangler dev"
         - "deploy": "wrangler deploy"

    2. `api/tsconfig.json`:
       - target: ES2022, module: ESNext, moduleResolution: bundler
       - strict: true, skipLibCheck: true
       - types: ["@cloudflare/workers-types"]
       - include: ["src"]

    3. `api/wrangler.toml`:
       ```toml
       name = "claw-fm-api"
       main = "src/index.ts"
       compatibility_date = "2026-01-01"

       [[d1_databases]]
       binding = "DB"
       database_name = "claw-fm"
       database_id = "local"

       [[r2_buckets]]
       binding = "AUDIO_BUCKET"
       bucket_name = "claw-fm-audio"
       ```
       Note: database_id = "local" is a placeholder. Real ID comes from `wrangler d1 create` during deployment. Local dev uses --local flag which ignores database_id.

    4. `api/src/index.ts`:
       ```typescript
       import { Hono } from 'hono'
       import { cors } from 'hono/cors'
       import type { HealthResponse } from '@claw/shared'

       type Bindings = {
         DB: D1Database
         AUDIO_BUCKET: R2Bucket
       }

       const app = new Hono<{ Bindings: Bindings }>()

       app.use('*', cors())

       app.get('/health', (c) => {
         const response: HealthResponse = {
           status: 'ok',
           timestamp: Date.now()
         }
         return c.json(response)
       })

       export default app
       ```
       Import HealthResponse from @claw/shared to verify the cross-package import works.
       Use Hono's built-in cors() middleware.
       Type the Bindings with D1Database and R2Bucket for future use.

    5. Run `pnpm install` at project root to link all workspaces.

    Do NOT use `create-hono` scaffolding tool -- manual setup is simpler for this small API and avoids unwanted boilerplate files.
    Do NOT add zod validation yet -- that comes in Phase 2 when real data flows through.
  </action>
  <verify>
    - `cd api && pnpm exec wrangler dev --local` starts successfully (Ctrl+C after confirming startup)
    - `curl http://localhost:8787/health` returns `{"status":"ok","timestamp":...}`
    - TypeScript compilation: `cd api && pnpm exec tsc --noEmit` passes without errors
  </verify>
  <done>
    Hono API runs locally via wrangler dev. GET /health returns JSON with status and timestamp. Bindings for DB (D1) and AUDIO_BUCKET (R2) are declared in wrangler.toml. @claw/shared import compiles successfully.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create D1 tracks schema migration and apply locally</name>
  <files>
    api/migrations/0001_tracks-schema.sql
  </files>
  <action>
    Create the D1 migration for the tracks table:

    1. Create `api/migrations/0001_tracks-schema.sql`:
       ```sql
       -- Tracks table: stores metadata for submitted audio tracks
       CREATE TABLE IF NOT EXISTS tracks (
         id INTEGER PRIMARY KEY AUTOINCREMENT,
         title TEXT NOT NULL,
         wallet TEXT NOT NULL,
         duration INTEGER NOT NULL,
         file_url TEXT NOT NULL,
         cover_url TEXT,
         created_at INTEGER NOT NULL DEFAULT (unixepoch()),
         play_count INTEGER NOT NULL DEFAULT 0,
         tip_weight REAL NOT NULL DEFAULT 0.0
       );

       -- Index for querying tracks by submitter wallet
       CREATE INDEX idx_tracks_wallet ON tracks(wallet);

       -- Index for decay-weighted rotation (created_at used for age decay)
       CREATE INDEX idx_tracks_created_at ON tracks(created_at);

       -- Index for queue selection (tip_weight for weighted random)
       CREATE INDEX idx_tracks_tip_weight ON tracks(tip_weight);
       ```

    Column notes:
    - `id`: INTEGER PRIMARY KEY AUTOINCREMENT -- D1/SQLite standard auto-increment
    - `title`: TEXT NOT NULL -- track name provided by agent
    - `wallet`: TEXT NOT NULL -- agent's wallet address (identity)
    - `duration`: INTEGER NOT NULL -- duration in seconds
    - `file_url`: TEXT NOT NULL -- R2 URL path to audio file
    - `cover_url`: TEXT nullable -- optional cover art URL, NULL means use identicon fallback
    - `created_at`: INTEGER NOT NULL DEFAULT (unixepoch()) -- Unix timestamp
    - `play_count`: INTEGER NOT NULL DEFAULT 0 -- how many times played
    - `tip_weight`: REAL NOT NULL DEFAULT 0.0 -- accumulated tip weight for rotation boost

    2. Apply migration locally:
       ```bash
       cd api && pnpm exec wrangler d1 migrations apply DB --local
       ```

    3. Verify schema by querying:
       ```bash
       cd api && pnpm exec wrangler d1 execute DB --local --command "SELECT sql FROM sqlite_master WHERE type='table' AND name='tracks';"
       ```

    Do NOT run PRAGMA optimize yet -- no data in table, so nothing to optimize.
    Do NOT use wrangler d1 migrations create -- just create the SQL file directly in the migrations folder (wrangler picks up any SQL files in migrations/ folder).
  </action>
  <verify>
    - `cd api && pnpm exec wrangler d1 migrations apply DB --local` succeeds
    - `cd api && pnpm exec wrangler d1 execute DB --local --command "PRAGMA table_info(tracks);"` shows all columns (id, title, wallet, duration, file_url, cover_url, created_at, play_count, tip_weight)
    - `cd api && pnpm exec wrangler d1 execute DB --local --command "SELECT name FROM sqlite_master WHERE type='index';"` shows idx_tracks_wallet, idx_tracks_created_at, idx_tracks_tip_weight
  </verify>
  <done>
    D1 tracks table exists locally with correct columns (id, title, wallet, duration, file_url, cover_url, created_at, play_count, tip_weight) and three indexes (wallet, created_at, tip_weight). Migration file committed to git in api/migrations/.
  </done>
</task>

</tasks>

<verification>
1. `pnpm install` at root succeeds with no errors
2. `cd api && pnpm exec wrangler dev --local` starts Hono API on port 8787
3. `curl http://localhost:8787/health` returns `{"status":"ok","timestamp":...}`
4. `cd api && pnpm exec tsc --noEmit` passes (confirms @claw/shared import works)
5. D1 migration applied locally with correct tracks table schema and indexes
</verification>

<success_criteria>
- Monorepo root configured with pnpm workspaces (api, web, packages/*)
- @claw/shared package exports Track, ApiResponse, HealthResponse types
- Hono API serves /health endpoint via wrangler dev
- D1 tracks table schema matches Track interface fields
- R2 bucket binding declared in wrangler.toml
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md`
</output>
