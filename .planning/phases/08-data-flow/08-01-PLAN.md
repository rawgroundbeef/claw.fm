---
phase: 08-data-flow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/shared/src/index.ts
  - api/src/lib/text-utils.ts
autonomous: true

must_haves:
  truths:
    - "NowPlayingTrack interface includes artistUsername, artistDisplayName, artistAvatarUrl, and artistBio as optional fields"
    - "Bio truncation helper truncates text to 100 characters at word boundaries with ellipsis"
    - "Existing consumers of NowPlayingTrack are not broken (all new fields are optional)"
  artifacts:
    - path: "packages/shared/src/index.ts"
      provides: "Extended NowPlayingTrack interface with 4 profile enrichment fields"
      contains: "artistUsername"
    - path: "api/src/lib/text-utils.ts"
      provides: "truncateBio helper function"
      exports: ["truncateBio"]
  key_links:
    - from: "api/src/lib/text-utils.ts"
      to: "packages/shared/src/index.ts"
      via: "truncateBio output populates artistBio field"
      pattern: "truncateBio"
---

<objective>
Extend the shared NowPlayingTrack type with artist profile fields and create the bio truncation helper.

Purpose: Lay the type foundation so Plan 02 can add LEFT JOIN enrichment to now-playing and queue endpoints without type errors.
Output: Extended NowPlayingTrack interface and reusable truncateBio utility.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/shared/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend NowPlayingTrack and create truncateBio helper</name>
  <files>packages/shared/src/index.ts, api/src/lib/text-utils.ts</files>
  <action>
1. In `packages/shared/src/index.ts`, add four optional fields to the existing `NowPlayingTrack` interface, immediately after the `genre: string` field:

```typescript
  // Artist profile enrichment (Phase 8 â€” optional, NULL if no profile)
  artistUsername?: string
  artistDisplayName?: string
  artistAvatarUrl?: string
  artistBio?: string           // Truncated to ~100 chars server-side
```

Do NOT modify any other interfaces or types. These fields are backward-compatible additions.

2. Create new file `api/src/lib/text-utils.ts` with a `truncateBio` function:

```typescript
/**
 * Truncate bio text to a maximum length, preferring word boundaries.
 * Used server-side to keep KV cache payloads small and display consistent.
 */
export function truncateBio(text: string, maxLength: number = 100): string {
  if (text.length <= maxLength) {
    return text
  }

  const truncated = text.slice(0, maxLength)
  const lastSpace = truncated.lastIndexOf(' ')
  const threshold = maxLength * 0.8

  if (lastSpace > threshold) {
    return truncated.slice(0, lastSpace) + '...'
  }

  return truncated + '...'
}
```

This function:
- Returns text unchanged if already within maxLength
- Prefers word-boundary truncation (last space in final 20% of string)
- Falls back to hard truncation with ellipsis if no suitable space found
- Default maxLength is 100 characters (matching CONTEXT.md decision)
  </action>
  <verify>
Run `cd /Users/rawgroundbeef/Projects/claw.fm && npx tsc --noEmit -p packages/shared/tsconfig.json` to confirm shared types compile.
Run `cd /Users/rawgroundbeef/Projects/claw.fm && npx tsc --noEmit -p api/tsconfig.json` to confirm API compiles with new file.
Verify NowPlayingTrack has the 4 new optional fields by grepping: `grep -A 15 'interface NowPlayingTrack' packages/shared/src/index.ts`
Verify truncateBio is exported: `grep 'export function truncateBio' api/src/lib/text-utils.ts`
  </verify>
  <done>
NowPlayingTrack interface has artistUsername, artistDisplayName, artistAvatarUrl, and artistBio as optional string fields. truncateBio function exists in api/src/lib/text-utils.ts and is importable. Both packages compile without errors.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes for both shared and api packages
- NowPlayingTrack interface contains all 4 new optional fields
- truncateBio correctly truncates long strings at word boundaries
- No existing code is broken (all new fields are optional)
</verification>

<success_criteria>
- NowPlayingTrack has artistUsername, artistDisplayName, artistAvatarUrl, artistBio fields (all optional strings)
- truncateBio("short") returns "short" unchanged
- truncateBio("a".repeat(150)) returns a 103-char string ending in "..."
- TypeScript compiles cleanly in both packages
</success_criteria>

<output>
After completion, create `.planning/phases/08-data-flow/08-01-SUMMARY.md`
</output>
