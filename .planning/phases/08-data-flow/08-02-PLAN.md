---
phase: 08-data-flow
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - api/src/routes/now-playing.ts
  - api/src/routes/queue.ts
  - api/src/routes/profile.ts
  - api/src/routes/avatar.ts
autonomous: true

must_haves:
  truths:
    - "Now-playing API response includes artistUsername and artistDisplayName when the track's wallet has a profile"
    - "Now-playing API response for tracks without profiles omits profile fields (no errors, no nulls in JSON)"
    - "Queue API response includes profile enrichment for all tracks and currentlyPlaying"
    - "nextTrack in now-playing response is also enriched with profile data"
    - "Updating a profile or uploading an avatar invalidates the now-playing KV cache"
  artifacts:
    - path: "api/src/routes/now-playing.ts"
      provides: "LEFT JOIN enrichment for current track and nextTrack"
      contains: "LEFT JOIN artist_profiles"
    - path: "api/src/routes/queue.ts"
      provides: "LEFT JOIN enrichment for queue tracks and currentlyPlaying"
      contains: "LEFT JOIN artist_profiles"
    - path: "api/src/routes/profile.ts"
      provides: "Cache invalidation after profile create/update"
      contains: "invalidateNowPlaying"
    - path: "api/src/routes/avatar.ts"
      provides: "Cache invalidation after avatar upload"
      contains: "invalidateNowPlaying"
  key_links:
    - from: "api/src/routes/now-playing.ts"
      to: "artist_profiles table"
      via: "LEFT JOIN on wallet"
      pattern: "LEFT JOIN artist_profiles ap ON t\\.wallet = ap\\.wallet"
    - from: "api/src/routes/queue.ts"
      to: "artist_profiles table"
      via: "LEFT JOIN on wallet"
      pattern: "LEFT JOIN artist_profiles ap ON t\\.wallet = ap\\.wallet"
    - from: "api/src/routes/profile.ts"
      to: "api/src/lib/kv-cache.ts"
      via: "invalidateNowPlaying import and call"
      pattern: "invalidateNowPlaying"
    - from: "api/src/routes/avatar.ts"
      to: "api/src/lib/kv-cache.ts"
      via: "invalidateNowPlaying import and call"
      pattern: "invalidateNowPlaying"
---

<objective>
Add LEFT JOIN enrichment to now-playing and queue endpoints, and add KV cache invalidation to profile and avatar write endpoints.

Purpose: Listeners see artist display names and avatars in the player for every track, with graceful wallet-address fallback. Profile updates are reflected within one polling cycle.
Output: Enriched API responses and cache invalidation on profile mutations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-data-flow/08-01-SUMMARY.md
@api/src/routes/now-playing.ts
@api/src/routes/queue.ts
@api/src/routes/profile.ts
@api/src/routes/avatar.ts
@api/src/lib/kv-cache.ts
@api/src/lib/text-utils.ts
@packages/shared/src/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add LEFT JOIN enrichment to now-playing and queue endpoints</name>
  <files>api/src/routes/now-playing.ts, api/src/routes/queue.ts</files>
  <action>
**In `api/src/routes/now-playing.ts`:**

1. Add import at top: `import { truncateBio } from '../lib/text-utils'`

2. Replace the current track query (Step 4, around line 44) with a LEFT JOIN query:

```sql
SELECT
  t.id,
  t.title,
  t.wallet,
  t.artist_name,
  t.duration,
  t.file_url,
  t.cover_url,
  t.genre,
  ap.username AS profile_username,
  ap.display_name AS profile_display_name,
  ap.avatar_url AS profile_avatar_url,
  ap.bio AS profile_bio
FROM tracks t
LEFT JOIN artist_profiles ap ON t.wallet = ap.wallet
WHERE t.id = ?
```

Update the generic type parameter on `.first<>()` to include the 4 new nullable columns:
```typescript
profile_username: string | null
profile_display_name: string | null
profile_avatar_url: string | null
profile_bio: string | null
```

3. In the NowPlayingTrack construction (around line 73), add the 4 enrichment fields after `genre`:
```typescript
artistUsername: currentTrack.profile_username || undefined,
artistDisplayName: currentTrack.profile_display_name || undefined,
artistAvatarUrl: currentTrack.profile_avatar_url || undefined,
artistBio: currentTrack.profile_bio ? truncateBio(currentTrack.profile_bio) : undefined,
```

Use `|| undefined` to convert SQL NULL to JS undefined (omitted from JSON). Do NOT use `?? undefined` because empty strings should also become undefined.

4. Apply the SAME LEFT JOIN pattern to the nextTrack query (Step 5, around line 92). Update the SELECT, type annotation, and track construction identically to the current track.

**In `api/src/routes/queue.ts`:**

1. Add import at top: `import { truncateBio } from '../lib/text-utils'`

2. Replace the queue tracks query (Step 4, around line 37) with the LEFT JOIN version:

```sql
SELECT
  t.id,
  t.title,
  t.wallet,
  t.artist_name,
  t.duration,
  t.file_url,
  t.cover_url,
  t.genre,
  ap.username AS profile_username,
  ap.display_name AS profile_display_name,
  ap.avatar_url AS profile_avatar_url,
  ap.bio AS profile_bio
FROM tracks t
LEFT JOIN artist_profiles ap ON t.wallet = ap.wallet
WHERE t.id IN (${placeholders})
```

Update the generic type on `.all<>()` to include the 4 nullable columns.

3. In the trackMap construction loop, add the 4 enrichment fields:
```typescript
artistUsername: row.profile_username || undefined,
artistDisplayName: row.profile_display_name || undefined,
artistAvatarUrl: row.profile_avatar_url || undefined,
artistBio: row.profile_bio ? truncateBio(row.profile_bio) : undefined,
```

4. Apply the SAME LEFT JOIN to the currentlyPlaying query (Step 5, around line 84). Update SELECT, type annotation, and track construction.

**CRITICAL anti-patterns to avoid:**
- Do NOT put COALESCE in the JOIN ON clause (prevents index usage)
- Do NOT add LEFT JOIN to QueueBrain internal queries (enrichment is API-layer only)
- Do NOT use `?? undefined` -- use `|| undefined` to also convert empty strings
- Keep cover_url mapping exactly as-is: `/audio/${row.cover_url}` -- do NOT apply the identicon passthrough pattern here (that's in artist.ts, not these endpoints)
  </action>
  <verify>
Run `cd /Users/rawgroundbeef/Projects/claw.fm && npx tsc --noEmit -p api/tsconfig.json` to confirm TypeScript compiles.
Grep for LEFT JOIN in both files: `grep 'LEFT JOIN artist_profiles' api/src/routes/now-playing.ts api/src/routes/queue.ts`
Grep for truncateBio import: `grep 'truncateBio' api/src/routes/now-playing.ts api/src/routes/queue.ts`
Verify no COALESCE in JOIN condition: `grep -n 'ON.*COALESCE' api/src/routes/now-playing.ts api/src/routes/queue.ts` (should return nothing)
Count LEFT JOINs: now-playing.ts should have 2 (currentTrack + nextTrack), queue.ts should have 2 (queue tracks + currentlyPlaying).
  </verify>
  <done>
All 4 D1 queries in now-playing.ts and queue.ts use LEFT JOIN to artist_profiles. Profile fields are mapped with || undefined for clean JSON output. nextTrack and currentlyPlaying are also enriched. TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add KV cache invalidation to profile and avatar endpoints</name>
  <files>api/src/routes/profile.ts, api/src/routes/avatar.ts</files>
  <action>
**In `api/src/routes/profile.ts`:**

1. Add import at top: `import { invalidateNowPlaying } from '../lib/kv-cache'`

2. After the successful profile creation/update (after the UPDATE or INSERT query succeeds, around line 106, right before the "Step 5: Fetch and return the profile" comment), add:
```typescript
// Invalidate now-playing cache so next poll reflects profile changes
await invalidateNowPlaying(c.env.KV)
```

Note: The Env type in profile.ts already includes `KV: KVNamespace` in its Bindings, so no type changes needed.

Place the invalidation AFTER the DB write succeeds but BEFORE fetching the profile for the response. This ensures the cache is invalidated even if the response-fetch fails.

**In `api/src/routes/avatar.ts`:**

1. Add import at top: `import { invalidateNowPlaying } from '../lib/kv-cache'`

2. The Env type currently does NOT include KV. Add `KV: KVNamespace` to the Bindings type:
```typescript
type Env = {
  Bindings: {
    DB: D1Database
    AUDIO_BUCKET: R2Bucket
    PLATFORM_WALLET: string
    IMAGES?: any
    KV: KVNamespace
  }
}
```

3. After the profile update with avatar URL (after the UPDATE query around line 133, before "Step 7: Return success"), add:
```typescript
// Invalidate now-playing cache so avatar appears in player
await invalidateNowPlaying(c.env.KV)
```

**Key principle:** invalidateNowPlaying uses best-effort error handling (try/catch with silent failure) -- it will never block the profile/avatar response. This is the existing pattern from kv-cache.ts.
  </action>
  <verify>
Run `cd /Users/rawgroundbeef/Projects/claw.fm && npx tsc --noEmit -p api/tsconfig.json` to confirm TypeScript compiles.
Grep for invalidateNowPlaying in both files: `grep 'invalidateNowPlaying' api/src/routes/profile.ts api/src/routes/avatar.ts`
Verify import exists: `grep "from '../lib/kv-cache'" api/src/routes/profile.ts api/src/routes/avatar.ts`
Verify KV binding in avatar.ts Env type: `grep 'KV:' api/src/routes/avatar.ts`
  </verify>
  <done>
Profile updates and avatar uploads invalidate the now-playing KV cache. Cache invalidation is best-effort (never blocks the response). avatar.ts Env type includes KV binding. TypeScript compiles without errors.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit -p api/tsconfig.json` passes
- now-playing.ts has LEFT JOIN for currentTrack AND nextTrack queries
- queue.ts has LEFT JOIN for queue tracks AND currentlyPlaying queries
- profile.ts calls invalidateNowPlaying after profile create/update
- avatar.ts calls invalidateNowPlaying after avatar upload
- No COALESCE in any JOIN ON clause
- No LEFT JOIN in QueueBrain (only in API route handlers)
- All profile fields use `|| undefined` conversion (not `?? undefined`)
</verification>

<success_criteria>
- GET /api/now-playing returns artistUsername, artistDisplayName, artistAvatarUrl, artistBio when the track's wallet has a profile
- GET /api/now-playing omits those fields (not null, just absent) when no profile exists
- GET /api/queue returns enriched tracks and currentlyPlaying with profile data
- PUT /api/profile invalidates the now-playing cache after any profile change
- POST /api/avatar invalidates the now-playing cache after avatar upload
- TypeScript compiles cleanly across api and shared packages
</success_criteria>

<output>
After completion, create `.planning/phases/08-data-flow/08-02-SUMMARY.md`
</output>
