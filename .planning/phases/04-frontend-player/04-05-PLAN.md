---
phase: 04-frontend-player
plan: 05
type: execute
wave: 3
depends_on: ["04-02", "04-03", "04-04"]
files_modified:
  - web/src/App.tsx
  - web/src/index.css
autonomous: true

must_haves:
  truths:
    - "Listener opens claw.fm and sees now-playing info + visualizer + play button before pressing play"
    - "Pressing play starts audio at the correct server-synced position"
    - "Track transitions crossfade audio and smoothly update displayed track info"
    - "Volume slider works and mute toggles audio"
    - "Progress bar advances in real time showing elapsed/remaining"
    - "Empty state shows when no tracks exist instead of broken player"
    - "Visualizer shows live waveform when playing, idle animation when paused"
  artifacts:
    - path: "web/src/App.tsx"
      provides: "Full application wiring: hooks + components + layout"
      min_lines: 80
  key_links:
    - from: "web/src/App.tsx"
      to: "web/src/hooks/useNowPlaying.ts"
      via: "import and call useNowPlaying"
      pattern: "useNowPlaying"
    - from: "web/src/App.tsx"
      to: "web/src/hooks/useCrossfade.ts"
      via: "import and call useCrossfade"
      pattern: "useCrossfade"
    - from: "web/src/App.tsx"
      to: "web/src/hooks/useServerTime.ts"
      via: "import and call useServerTime for sync"
      pattern: "useServerTime"
    - from: "web/src/App.tsx"
      to: "web/src/components/Player/PlayerBar.tsx"
      via: "renders PlayerBar with wired props"
      pattern: "PlayerBar"
    - from: "web/src/App.tsx"
      to: "web/src/components/Visualizer/Waveform.tsx"
      via: "renders Waveform with analyserNode"
      pattern: "Waveform"
---

<objective>
Wire all hooks and components together in App.tsx to create the complete, functioning player application.

Purpose: This is the integration plan -- connecting the audio engine (plan 02), visualizer (plan 03), and UI components (plan 04) into a working application. After this plan, opening claw.fm in a browser shows a working radio player.

Output: Rewritten App.tsx with full application wiring, updated index.css with custom styles
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-frontend-player/04-CONTEXT.md
@.planning/phases/04-frontend-player/04-01-SUMMARY.md
@.planning/phases/04-frontend-player/04-02-SUMMARY.md
@.planning/phases/04-frontend-player/04-03-SUMMARY.md
@.planning/phases/04-frontend-player/04-04-SUMMARY.md

@packages/shared/src/index.ts -- NowPlayingResponse, NowPlayingTrack types
@web/src/App.tsx -- Current placeholder to replace
@web/src/index.css -- Current Tailwind directives
@web/src/hooks/useNowPlaying.ts
@web/src/hooks/useCrossfade.ts
@web/src/hooks/useServerTime.ts
@web/src/hooks/useAudioSync.ts
@web/src/components/Player/PlayerBar.tsx
@web/src/components/Player/PlayButton.tsx
@web/src/components/Player/VolumeControl.tsx
@web/src/components/Player/NowPlaying.tsx
@web/src/components/Player/ProgressBar.tsx
@web/src/components/Visualizer/Waveform.tsx
@web/src/components/EmptyState.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: App.tsx full integration wiring</name>
  <files>web/src/App.tsx</files>
  <action>
Rewrite App.tsx to wire all hooks and components into the complete player application.

**Layout structure** (from CONTEXT.md):
```
+----------------------------------+
|           claw.fm header         |  (small, top)
|                                  |
|      [Large Waveform Area]       |  (main page, dominant)
|                                  |
|    Track Title - Artist Name     |  (prominent, centered)
|                                  |
+----------------------------------+
| [Art] Title - Artist | [>] [===] |  (player bar, fixed bottom)
+----------------------------------+
```

**Hook wiring:**
1. `useServerTime()` -- get `serverOffset`, `isSynced`.
2. `useNowPlaying()` -- get `state`, `track`, `nextTrack`, `startedAt`, `endsAt`, `message`, `timeRemaining`.
3. `useCrossfade(...)` -- pass now-playing state and serverOffset. Get `play`, `pause`, `isPlaying`, `isLoading`, `currentTrack`, `activeAnalyser`, `currentTime`, `duration`.
4. Volume state: `useState<number>(0.8)` for volume, `useState<boolean>(false)` for muted. Wire to `useCrossfade.setVolume()`.

**State machine:**
- `nowPlaying.state === 'waiting'`: Show EmptyState component. PlayerBar hidden or shows disabled state.
- `nowPlaying.state === 'playing' && !isPlaying`: Pre-play landing. Show track info + visualizer (idle animation) + prominent PlayButton. PlayerBar visible with play button.
- `nowPlaying.state === 'playing' && isPlaying`: Active playback. Waveform animates, progress advances, all controls active.
- `nowPlaying.state === 'loading'`: Show loading indicator (brief).

**Main content area:**
- Full viewport height minus player bar (`min-h-screen pb-20`).
- Centered content with flex column.
- Small "claw.fm" text at top (`text-sm font-medium text-gray-400 tracking-widest uppercase`).
- Waveform component takes up significant space in the center (`h-48 sm:h-64 w-full max-w-2xl`).
- Below waveform: current track title (`text-2xl font-bold`) and artist (`text-lg text-gray-500`). Centered.
- These text elements transition smoothly on track change (`transition-opacity duration-1000`).

**PlayerBar wiring:**
- Left: `<NowPlaying track={currentTrack} />` -- uses the track from useCrossfade (which tracks active player's track).
- Center: `<PlayButton isPlaying={isPlaying} isLoading={isLoading} disabled={nowPlaying.state === 'waiting'} onPlay={play} onPause={pause} />` and `<ProgressBar currentTime={currentTime} duration={duration} isPlaying={isPlaying} />`.
- Right: `<VolumeControl volume={muted ? 0 : volume} isMuted={muted} onVolumeChange={handleVolumeChange} onMuteToggle={handleMuteToggle} />`.

**Volume handling:**
- `handleVolumeChange(v)`: set volume state, unmute if muted, call `crossfade.setVolume(v)`.
- `handleMuteToggle()`: toggle muted state. If muting: call `crossfade.setVolume(0)`. If unmuting: call `crossfade.setVolume(volume)`.

**Track info crossfade in main area:**
From CONTEXT.md: "Track transitions: seamless -- track title/art crossfade in sync with audio crossfade, no loading indicators."
- Use a key-based transition: when `currentTrack?.id` changes, animate opacity from 0 to 1 on the new track info. Use CSS transition on a wrapper div with `key={currentTrack?.id}`.

**EmptyState placement:**
- When `nowPlaying.state === 'waiting'`, render `<EmptyState />` instead of the waveform + track info area.
- Player bar still shows but with disabled play button.
  </action>
  <verify>
Run `cd /Users/rawgroundbeef/Projects/claw.fm && pnpm --filter claw-fm-web exec tsc --noEmit` -- no type errors. Run `cd /Users/rawgroundbeef/Projects/claw.fm && pnpm --filter claw-fm-web build` -- build succeeds with no errors.
  </verify>
  <done>App.tsx wires all hooks and components. Layout has main visualizer area + bottom player bar. State machine handles waiting/pre-play/playing states. Volume, mute, play/pause all connected.</done>
</task>

<task type="auto">
  <name>Task 2: Custom CSS for range input and transitions</name>
  <files>web/src/index.css</files>
  <action>
Add custom CSS to index.css (after the Tailwind directives) for elements that need styling beyond Tailwind utilities:

**Range input styling** (for volume slider):
```css
/* Custom range input styling */
input[type="range"] {
  -webkit-appearance: none;
  appearance: none;
  background: transparent;
  cursor: pointer;
}

input[type="range"]::-webkit-slider-track {
  height: 4px;
  border-radius: 2px;
  background: #e5e7eb; /* gray-200 */
}

input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 14px;
  height: 14px;
  border-radius: 50%;
  background: #0066FF; /* electric brand color */
  margin-top: -5px;
  border: none;
}

/* Firefox */
input[type="range"]::-moz-range-track {
  height: 4px;
  border-radius: 2px;
  background: #e5e7eb;
}

input[type="range"]::-moz-range-thumb {
  width: 14px;
  height: 14px;
  border-radius: 50%;
  background: #0066FF;
  border: none;
}
```

**Smooth transitions for track info:**
```css
/* Track info crossfade transition */
.track-info-enter {
  opacity: 0;
  transform: translateY(4px);
}
.track-info-active {
  opacity: 1;
  transform: translateY(0);
  transition: opacity 1s ease, transform 1s ease;
}
```

**Body scroll padding for fixed player bar:**
```css
body {
  padding-bottom: 5rem; /* pb-20 to prevent content behind fixed player bar */
}
```

Keep the existing Tailwind directives at the top. Add new styles below them.
  </action>
  <verify>
Run `cd /Users/rawgroundbeef/Projects/claw.fm && pnpm --filter claw-fm-web build` -- build succeeds. Check that index.css contains Tailwind directives AND custom styles.
  </verify>
  <done>Custom CSS handles range input styling (cross-browser), track info transitions, and body padding for fixed player bar. Build succeeds.</done>
</task>

</tasks>

<verification>
- `pnpm --filter claw-fm-web build` succeeds with no errors
- App.tsx imports and uses: useServerTime, useNowPlaying, useCrossfade, PlayerBar, PlayButton, VolumeControl, NowPlaying, ProgressBar, Waveform, EmptyState
- Layout: main visualizer area + fixed bottom player bar
- State machine: waiting -> EmptyState, playing + paused -> pre-play landing, playing + active -> full player
- Volume and mute controls wired to crossfade engine
</verification>

<success_criteria>
The complete player application is wired and builds successfully. Opening claw.fm shows: (1) the waveform visualizer and track info in the main area, (2) a fixed bottom player bar with play/pause, progress, volume controls, (3) empty state when no tracks, (4) smooth crossfade transitions between tracks. All requirements PLAY-01 through PLAY-05, PLAY-08, PLAY-09, UI-01, UI-04, UI-06 are addressed.
</success_criteria>

<output>
After completion, create `.planning/phases/04-frontend-player/04-05-SUMMARY.md`
</output>
