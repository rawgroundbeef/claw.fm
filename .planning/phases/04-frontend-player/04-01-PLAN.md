---
phase: 04-frontend-player
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - web/src/utils/audioContext.ts
  - web/src/utils/equalPowerCurve.ts
  - web/src/utils/timeSync.ts
  - web/src/hooks/useServerTime.ts
  - web/src/hooks/useAudioSync.ts
  - web/vite.config.ts
  - api/wrangler.toml
autonomous: true

must_haves:
  truths:
    - "AudioContext singleton exists and can be imported from any component"
    - "Server time offset can be calculated from /api/now-playing response"
    - "Equal-power crossfade gains can be calculated for any position 0-1"
    - "Vite dev server proxies /api/* requests to wrangler dev"
    - "R2 CORS is configured for Web Audio crossOrigin access"
  artifacts:
    - path: "web/src/utils/audioContext.ts"
      provides: "Singleton AudioContext with getAudioContext() and resumeAudioContext()"
      exports: ["getAudioContext", "resumeAudioContext"]
    - path: "web/src/utils/equalPowerCurve.ts"
      provides: "Equal-power crossfade gain calculation"
      exports: ["calculateEqualPowerGains"]
    - path: "web/src/utils/timeSync.ts"
      provides: "Server time offset calculation from HTTP response"
      exports: ["calculateServerOffset", "getCorrectPlaybackPosition"]
    - path: "web/src/hooks/useServerTime.ts"
      provides: "React hook for continuous server time sync"
      exports: ["useServerTime"]
    - path: "web/src/hooks/useAudioSync.ts"
      provides: "React hook for audio position sync with drift correction"
      exports: ["useAudioSync"]
  key_links:
    - from: "web/src/hooks/useServerTime.ts"
      to: "web/src/utils/timeSync.ts"
      via: "import calculateServerOffset"
      pattern: "import.*calculateServerOffset.*from.*timeSync"
    - from: "web/src/hooks/useAudioSync.ts"
      to: "web/src/utils/timeSync.ts"
      via: "import getCorrectPlaybackPosition"
      pattern: "import.*getCorrectPlaybackPosition.*from.*timeSync"
    - from: "web/vite.config.ts"
      to: "/api/*"
      via: "Vite proxy configuration"
      pattern: "proxy.*api"
---

<objective>
Create the audio utility foundation and infrastructure configuration that all player hooks and components depend on.

Purpose: Every downstream plan (audio hooks, visualizer, player UI) imports from these utilities. R2 CORS and Vite proxy must be configured before any audio playback testing is possible. This is the leaf dependency -- nothing else can work without it.

Output: 5 new TypeScript files (3 utils, 2 hooks), 2 config modifications (vite.config.ts, wrangler.toml)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-frontend-player/04-RESEARCH.md
@.planning/phases/04-frontend-player/04-CONTEXT.md

@packages/shared/src/index.ts -- NowPlayingResponse type with startedAt/endsAt timestamps
@web/vite.config.ts -- Current Vite config to add proxy to
@api/wrangler.toml -- Current wrangler config to add CORS to
@web/tailwind.config.js -- Existing Tailwind config (brand color 'electric': '#0066FF')
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audio utility modules</name>
  <files>
    web/src/utils/audioContext.ts
    web/src/utils/equalPowerCurve.ts
    web/src/utils/timeSync.ts
  </files>
  <action>
Create three utility modules in `web/src/utils/`:

**audioContext.ts** - Singleton AudioContext:
- `getAudioContext()`: Returns singleton AudioContext instance. Creates on first call. Never creates multiple.
- `resumeAudioContext()`: If context state is 'suspended', calls `ctx.resume()`. Returns Promise<void>. This MUST be called inside a user click handler to comply with autoplay policy.
- Module-level `let audioContext: AudioContext | null = null`
- Export both functions

**equalPowerCurve.ts** - Crossfade gain calculator:
- `calculateEqualPowerGains(position: number): [number, number]`: Takes position 0-1 where 0 = full track1, 1 = full track2. Returns [gain1, gain2] using cosine curve: `gain1 = Math.cos(position * 0.5 * Math.PI)`, `gain2 = Math.cos((1.0 - position) * 0.5 * Math.PI)`. This prevents the volume dip that linear crossfade causes.
- Export the function

**timeSync.ts** - Server time offset:
- `calculateServerOffset(serverTime: number, clientSendTime: number, clientReceiveTime: number): number`: Calculates offset between server and client clocks. Uses round-trip time compensation: `estimatedServerTime = serverTime + (roundTrip / 2)`, returns `estimatedServerTime - clientReceiveTime`. Server time comes from the existing NowPlayingResponse (which includes timestamps). No separate time endpoint needed.
- `getCorrectPlaybackPosition(startedAt: number, durationMs: number, serverOffset: number): number`: Returns correct playback position in seconds. Calculates: `serverNow = Date.now() + serverOffset`, `elapsed = serverNow - startedAt`, clamps to 0...duration. Returns seconds (not ms).
- Export both functions
  </action>
  <verify>
Run `cd /Users/rawgroundbeef/Projects/claw.fm && pnpm --filter claw-fm-web exec tsc --noEmit` -- no type errors. Verify all three files exist and export the documented functions.
  </verify>
  <done>Three utility modules exist with correct exports and pass TypeScript compilation.</done>
</task>

<task type="auto">
  <name>Task 2: Time sync hooks and infrastructure config</name>
  <files>
    web/src/hooks/useServerTime.ts
    web/src/hooks/useAudioSync.ts
    web/vite.config.ts
    api/wrangler.toml
  </files>
  <action>
**useServerTime.ts** - Server time sync React hook:
- `useServerTime(pollIntervalMs = 30000)`: Hook that maintains server time offset.
- On mount and every `pollIntervalMs`: fetch `/api/now-playing`, record clientSendTime before fetch and clientReceiveTime after, extract server timestamp from response, call `calculateServerOffset()` from timeSync util.
- State: `{ offset: number, isSynced: boolean, getServerTime: () => number }`. `getServerTime()` returns `Date.now() + offset`.
- Uses `useEffect` for interval, `useState` for offset and isSynced.
- First sync sets isSynced to true.
- Handle fetch errors gracefully (keep last known offset, don't crash).

Note: The existing `/api/now-playing` endpoint returns timestamps (`startedAt`, `endsAt`) that are server-generated. The response itself carries server time implicitly. For offset calculation, use the health endpoint timestamp or add a `serverTime: Date.now()` field to the now-playing response. The simplest approach: use `Date.now()` on both sides -- the fetch round-trip gives us the server time from the response body. Add `serverTime` field to `NowPlayingResponse` in shared types if needed, or just use the health endpoint's `timestamp` field which already exists.

Actually, the simplest approach: call `/health` which returns `{ timestamp: Date.now() }`. This avoids coupling time sync to now-playing state. Use the health endpoint for time sync.

**useAudioSync.ts** - Audio position sync hook:
- `useAudioSync({ audioElement, startedAt, durationMs, serverOffset, isPlaying })`: Hook that keeps audio element synced to server time.
- On `startedAt` change (new track): calculate correct position via `getCorrectPlaybackPosition()`, set `audioElement.currentTime` if drift > 1 second.
- Periodic check every 10 seconds while playing: if drift > 1 second, re-seek to correct position. Log drift corrections to console.
- Returns `{ getCorrectPosition: () => number }` for UI progress display.
- Uses `useEffect` for the periodic interval and the track-change sync.

**vite.config.ts** - Add API proxy for development:
- Add `server.proxy` configuration: `'/api': { target: 'http://localhost:8787', changeOrigin: true }` and `'/health': { target: 'http://localhost:8787', changeOrigin: true }`. This allows the web dev server to proxy API requests to the wrangler dev server without CORS issues during development.

**wrangler.toml** - R2 CORS (note):
- R2 CORS cannot be configured via wrangler.toml. It requires either the S3 API (PutBucketCors) or the Cloudflare dashboard. For local development, wrangler dev serves R2 objects through the worker itself (via fetch handler), so CORS headers come from the Hono `cors()` middleware which is already configured with `app.use('*', cors())`. Add a comment to wrangler.toml noting: `# R2 CORS: For production, configure via S3 API or CF dashboard. For dev, Hono cors() middleware handles CORS.`

Actually, looking at the existing code: the now-playing response includes `fileUrl` which is an R2 URL. In production, audio files are served directly from R2 (not through the worker). So R2 CORS IS needed for production. But for local dev, wrangler serves R2 locally. The action here: add a comment about production CORS needs and ensure the Vite proxy handles `/audio/*` or whatever the R2 path is. Actually, the `fileUrl` in the track metadata is already a full R2 URL. For dev, it would be the local wrangler URL. No additional proxy needed for audio files in dev.

So the wrangler.toml change is minimal: just add the comment about R2 CORS for production deployment. The real CORS fix will happen at deploy time.
  </action>
  <verify>
Run `cd /Users/rawgroundbeef/Projects/claw.fm && pnpm --filter claw-fm-web exec tsc --noEmit` -- no type errors. Verify vite.config.ts has proxy configuration. Start dev server briefly with `cd /Users/rawgroundbeef/Projects/claw.fm && timeout 5 pnpm --filter claw-fm-web dev 2>&1 | head -20` to confirm it starts without errors.
  </verify>
  <done>Two React hooks exist (useServerTime, useAudioSync) with correct imports from utils. Vite dev proxy configured for /api and /health. TypeScript compiles clean.</done>
</task>

</tasks>

<verification>
- `pnpm --filter claw-fm-web exec tsc --noEmit` passes
- Files exist: `web/src/utils/audioContext.ts`, `web/src/utils/equalPowerCurve.ts`, `web/src/utils/timeSync.ts`, `web/src/hooks/useServerTime.ts`, `web/src/hooks/useAudioSync.ts`
- `vite.config.ts` contains proxy configuration for `/api` and `/health`
- All exports match documented interfaces
</verification>

<success_criteria>
Audio utility foundation is complete: singleton AudioContext, equal-power crossfade math, server time offset calculation, and two React hooks for time sync and audio position sync. Vite dev server proxies API calls to wrangler. All downstream plans can import from these modules.
</success_criteria>

<output>
After completion, create `.planning/phases/04-frontend-player/04-01-SUMMARY.md`
</output>
