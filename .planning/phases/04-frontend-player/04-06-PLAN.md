---
phase: 04-frontend-player
plan: 06
type: execute
wave: 4
depends_on: ["04-05"]
files_modified:
  - web/src/hooks/useRecovery.ts
  - web/src/components/ReconnectingIndicator.tsx
  - web/src/hooks/useAudioPlayer.ts
  - web/src/App.tsx
autonomous: true

must_haves:
  truths:
    - "If the network drops, a 'reconnecting' indicator appears and player auto-retries"
    - "If the tab is backgrounded and restored, audio resumes at the correct server-synced position"
    - "Player recovers from audio element errors without requiring page refresh"
    - "Loading/buffering states are always visible to the listener"
  artifacts:
    - path: "web/src/hooks/useRecovery.ts"
      provides: "Network error detection, tab visibility handling, auto-retry logic"
      exports: ["useRecovery"]
    - path: "web/src/components/ReconnectingIndicator.tsx"
      provides: "Visual indicator for reconnection state"
      exports: ["ReconnectingIndicator"]
  key_links:
    - from: "web/src/hooks/useRecovery.ts"
      to: "Page Visibility API"
      via: "document.addEventListener('visibilitychange')"
      pattern: "visibilitychange"
    - from: "web/src/hooks/useRecovery.ts"
      to: "window online/offline events"
      via: "addEventListener('online'|'offline')"
      pattern: "addEventListener.*online|offline"
    - from: "web/src/App.tsx"
      to: "web/src/hooks/useRecovery.ts"
      via: "import and wire recovery to audio engine"
      pattern: "useRecovery"
---

<objective>
Add error recovery and resilience: network drop handling, tab backgrounding recovery, and visual reconnection indicator.

Purpose: A radio player that breaks when the network hiccups or the tab is backgrounded is unusable. This plan adds the resilience layer that makes the player feel rock-solid. Requirements PLAY-06, PLAY-07, and UI-04 are specifically addressed here.

Output: 1 new hook, 1 new component, 2 modified files (useAudioPlayer for error events, App.tsx for recovery wiring)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-frontend-player/04-CONTEXT.md
@.planning/phases/04-frontend-player/04-05-SUMMARY.md

@web/src/App.tsx
@web/src/hooks/useAudioPlayer.ts
@web/src/hooks/useAudioSync.ts
@web/src/hooks/useServerTime.ts
@web/src/utils/timeSync.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: useRecovery hook and ReconnectingIndicator</name>
  <files>
    web/src/hooks/useRecovery.ts
    web/src/components/ReconnectingIndicator.tsx
  </files>
  <action>
**useRecovery.ts** - Handles three recovery scenarios:

Interface:
```typescript
interface UseRecoveryProps {
  isPlaying: boolean;
  onReconnect: () => void;       // Called when recovery should re-sync
  onVisibilityRestore: () => void; // Called when tab becomes visible again
}

interface UseRecoveryReturn {
  isOffline: boolean;
  isReconnecting: boolean;
  wasBackgrounded: boolean;
}
```

**Scenario 1: Network drop (PLAY-06)**
- Listen for `window` `online` and `offline` events.
- When `offline` fires: set `isOffline = true`.
- When `online` fires after being offline: set `isReconnecting = true`, call `onReconnect()`. After successful reconnection (poll `/health` until it responds, max 5 retries with 2s delay), set `isReconnecting = false`.
- The `onReconnect` callback (provided by App.tsx) should: re-fetch now-playing state, re-sync server time, seek audio to correct position.

**Scenario 2: Tab backgrounding (PLAY-07)**
- Listen for `document` `visibilitychange` event.
- When `document.hidden` becomes true: record that we were playing (`wasPlayingRef.current = isPlaying`). Do NOT pause audio -- browsers handle background audio differently and pausing creates a jarring experience on return.
- When `document.hidden` becomes false (tab restored): if we were playing, call `onVisibilityRestore()`. This callback should: re-sync server time offset, seek audio to correct position (using getCorrectPlaybackPosition), resume if paused.
- Set `wasBackgrounded = true` briefly (for UI indicator), then false after 2 seconds.

**Scenario 3: Audio element error (built into useAudioPlayer)**
- This will be handled by modifying useAudioPlayer in Task 2 to add error event listeners.

Cleanup: Remove all event listeners on unmount.

**ReconnectingIndicator.tsx** - Visual feedback:

Props:
```typescript
interface ReconnectingIndicatorProps {
  isReconnecting: boolean;
  isOffline: boolean;
}
```

Implementation:
From CONTEXT.md: "Network drop / tab restore: show brief 'reconnecting...' indicator, then auto-resume at correct position."

- When `isOffline`: show "Connection lost" in a subtle top banner or overlay.
- When `isReconnecting`: show "Reconnecting..." with a subtle animated dot.
- Positioned: fixed top-center, `fixed top-4 left-1/2 -translate-x-1/2 z-50`.
- Style: pill-shaped (`rounded-full px-4 py-2`), `bg-gray-900 text-white text-sm`. Subtle shadow.
- Animate in/out: `transition-all duration-300`. When hidden: `opacity-0 -translate-y-4 pointer-events-none`. When visible: `opacity-100 translate-y-0`.
- Auto-dismiss after reconnection succeeds (parent controls visibility).
  </action>
  <verify>
Run `cd /Users/rawgroundbeef/Projects/claw.fm && pnpm --filter claw-fm-web exec tsc --noEmit` -- no type errors.
  </verify>
  <done>useRecovery handles network drops and tab backgrounding. ReconnectingIndicator shows pill-shaped status overlay. Both compile without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Wire recovery into useAudioPlayer and App.tsx</name>
  <files>
    web/src/hooks/useAudioPlayer.ts
    web/src/App.tsx
  </files>
  <action>
**useAudioPlayer.ts modifications** - Add error recovery:

Add to the existing hook:
- Listen for `error` event on audio element. On error: set `hasError = true`, log the error type (`audio.error?.code` and `audio.error?.message`).
- Listen for `stalled` event: audio data stopped arriving. Set `isBuffering = true`. Auto-recover: wait 3 seconds, then try `audio.load()` followed by `audio.play()` and seek to correct position.
- Listen for `waiting` event: browser is waiting for data. Set `isBuffering = true`. Clear when `playing` event fires.
- Add `isBuffering: boolean` and `hasError: boolean` to the return interface.
- Add `retry()` method to return interface: calls `audio.load()`, waits for `canplaythrough`, then `audio.play()`. For when automatic recovery fails and manual retry is needed.

**App.tsx modifications** - Wire recovery:

Add to existing App.tsx:
- Import and use `useRecovery`.
- Wire `onReconnect`: re-fetch now-playing (trigger useNowPlaying refetch), re-sync time (trigger useServerTime re-sync), seek audio to correct position.
- Wire `onVisibilityRestore`: similar to reconnect but skip health check (we know we're online).
- Render `<ReconnectingIndicator isReconnecting={recovery.isReconnecting} isOffline={recovery.isOffline} />` at the top of the component tree.
- Show buffering state: when `isBuffering` is true from the crossfade hook, show a subtle buffering indicator on the PlayButton (the loading spinner state).
- UI-04 compliance: loading/buffering states are always visible. Map: `isLoading` = initial load, `isBuffering` = mid-playback buffer, `isReconnecting` = network recovery. Each has visual feedback.
  </action>
  <verify>
Run `cd /Users/rawgroundbeef/Projects/claw.fm && pnpm --filter claw-fm-web build` -- full build succeeds. Verify App.tsx imports useRecovery and ReconnectingIndicator. Verify useAudioPlayer exports isBuffering and hasError.
  </verify>
  <done>Audio player handles stalled/error events with auto-retry. App.tsx wires recovery for network drops and tab restore. ReconnectingIndicator shows during recovery. All loading/buffering states visible to user (PLAY-06, PLAY-07, UI-04).</done>
</task>

</tasks>

<verification>
- `pnpm --filter claw-fm-web build` succeeds with no errors
- useRecovery listens for online/offline and visibilitychange events
- useAudioPlayer handles error, stalled, waiting events on audio element
- ReconnectingIndicator renders as top-center pill with connection status
- App.tsx wires recovery callbacks to re-sync audio position
- All three recovery scenarios covered: network drop, tab background, audio error
</verification>

<success_criteria>
Player is resilient: network drops show "reconnecting" and auto-resume, backgrounded tabs re-sync on restore, audio errors trigger automatic retry. Loading and buffering states always visible. Requirements PLAY-06, PLAY-07, UI-04 fully addressed. The complete Phase 4 player is functional.
</success_criteria>

<output>
After completion, create `.planning/phases/04-frontend-player/04-06-SUMMARY.md`
</output>
