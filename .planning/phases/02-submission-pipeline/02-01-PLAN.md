---
phase: 02-submission-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - api/migrations/0002_submission-fields.sql
  - packages/shared/src/index.ts
  - api/src/routes/genres.ts
  - api/src/index.ts
  - api/wrangler.toml
autonomous: true

must_haves:
  truths:
    - "D1 tracks table has genre, description, tags, file_hash, artist_name columns"
    - "GET /api/genres returns a JSON array of valid genre strings including 'other'"
    - "Track type in @claw/shared includes all new fields (genre, description, tags, fileHash, artistName, coverUrl)"
    - "nodejs_compat flag is set in wrangler.toml for npm package compatibility"
  artifacts:
    - path: "api/migrations/0002_submission-fields.sql"
      provides: "D1 migration adding genre, description, tags, file_hash, artist_name columns and composite index"
      contains: "ALTER TABLE tracks"
    - path: "packages/shared/src/index.ts"
      provides: "Updated Track interface with all submission fields plus SubmissionError and SubmitResponse types"
      exports: ["Track", "ApiResponse", "HealthResponse", "SubmissionError", "SubmitResponse", "Genre", "GENRES"]
    - path: "api/src/routes/genres.ts"
      provides: "GET /api/genres endpoint returning valid genre list"
      contains: "GENRES"
    - path: "api/wrangler.toml"
      provides: "nodejs_compat flag for Workers npm compatibility"
      contains: "nodejs_compat"
  key_links:
    - from: "api/src/index.ts"
      to: "api/src/routes/genres.ts"
      via: "Hono route import and mount"
      pattern: "import.*genres"
    - from: "api/src/routes/genres.ts"
      to: "packages/shared/src/index.ts"
      via: "GENRES constant import"
      pattern: "import.*GENRES.*@claw/shared"
---

<objective>
Add D1 migration for submission-related columns, update shared types for the full submission pipeline, create the genres endpoint, and configure Workers compatibility flags.

Purpose: The existing D1 schema and shared types from Phase 1 are missing fields required by the submission pipeline (genre, description, tags, file_hash, artist_name). This plan adds them via migration and updates the canonical types. The genres endpoint is a simple self-documenting API that agents query to discover valid genres. The nodejs_compat flag is required for npm packages (file-type, get-mp3-duration) to work in Workers.

Output: Updated D1 schema, updated @claw/shared types, working /api/genres endpoint, configured wrangler.toml
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-submission-pipeline/02-CONTEXT.md
@.planning/phases/02-submission-pipeline/02-RESEARCH.md

# Existing files being modified
@packages/shared/src/index.ts
@api/src/index.ts
@api/wrangler.toml
@api/migrations/0001_tracks-schema.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: D1 migration, shared types, and wrangler config</name>
  <files>
    api/migrations/0002_submission-fields.sql
    packages/shared/src/index.ts
    api/wrangler.toml
  </files>
  <action>
    1. Create `api/migrations/0002_submission-fields.sql` with ALTER TABLE statements to add columns to the existing tracks table:
       - `genre TEXT NOT NULL DEFAULT 'other'` -- required field, default allows migration of existing rows
       - `description TEXT` -- optional
       - `tags TEXT` -- JSON array stored as string, optional
       - `file_hash TEXT NOT NULL DEFAULT ''` -- SHA-256 hex, default allows migration
       - `artist_name TEXT` -- optional, set on first submission per wallet
       Also add a composite index for duplicate detection:
       - `CREATE INDEX idx_tracks_wallet_hash ON tracks(wallet, file_hash);`

       NOTE: D1 uses SQLite. ALTER TABLE ADD COLUMN must be done one column at a time (SQLite limitation). Each ALTER TABLE statement should be separate. Do NOT use multi-column ALTER TABLE syntax.

    2. Apply the migration locally:
       `cd api && pnpm exec wrangler d1 migrations apply DB --local`

    3. Update `packages/shared/src/index.ts`:
       - Add `genre`, `description`, `tags` (string, for JSON array), `fileHash`, `artistName`, and `coverUrl` to the Track interface. The `coverUrl` field already exists in D1 as `cover_url` but was missing from the Phase 1 Track type.
       - Export a `GENRES` array constant with these values: `['electronic', 'hip-hop', 'indie', 'rock', 'pop', 'ambient', 'techno', 'house', 'experimental', 'jazz', 'r-and-b', 'soul', 'afrobeats', 'latin', 'other']` (use 'r-and-b' not 'r&b' for URL safety). Export the `Genre` type derived from typeof GENRES[number].
       - Add `SubmissionError` interface: `{ error: string; message: string; field?: string }`
       - Add `SubmitResponse` interface: `{ trackId: number; trackUrl: string; queuePosition: number }`
       - Keep all existing exports (Track, ApiResponse, HealthResponse) intact.

    4. Update `api/wrangler.toml`:
       - Add `compatibility_flags = ["nodejs_compat"]` under the compatibility_date line. This is required for npm packages like file-type and get-mp3-duration that use Node.js globals (Buffer, process).

    5. Verify TypeScript compilation still works:
       `cd /Users/rawgroundbeef/Projects/claw.fm && pnpm --filter claw-fm-api exec tsc --noEmit && pnpm --filter claw-fm-web exec tsc --noEmit`
  </action>
  <verify>
    - `cd api && pnpm exec wrangler d1 execute DB --local --command "PRAGMA table_info(tracks)"` shows genre, description, tags, file_hash, artist_name columns
    - `cd api && pnpm exec wrangler d1 execute DB --local --command "SELECT name FROM sqlite_master WHERE type='index' AND name='idx_tracks_wallet_hash'"` returns the index
    - TypeScript compilation passes for both api and web workspaces
  </verify>
  <done>
    D1 tracks table has all 14 columns (original 9 + 5 new). Composite index for duplicate detection exists. Track type includes all fields. GENRES constant and SubmissionError/SubmitResponse types are exported from @claw/shared. wrangler.toml has nodejs_compat flag.
  </done>
</task>

<task type="auto">
  <name>Task 2: Genres endpoint</name>
  <files>
    api/src/routes/genres.ts
    api/src/index.ts
  </files>
  <action>
    1. Create `api/src/routes/genres.ts`:
       - Import `GENRES` from `@claw/shared`
       - Create a Hono instance and add a GET `/` handler that returns `{ genres: GENRES, count: GENRES.length }`
       - Export the Hono instance as default

    2. Update `api/src/index.ts`:
       - Import the genres route
       - Mount it at `/api/genres` using `app.route('/api/genres', genresRoute)`
       - Keep existing /health endpoint and CORS middleware

    3. Verify the endpoint works:
       - Start wrangler dev, curl GET /api/genres, confirm it returns the genre list
  </action>
  <verify>
    - `cd api && pnpm exec wrangler dev --local` starts without errors
    - `curl http://localhost:8787/api/genres` returns JSON with `genres` array containing 15 items and `count: 15`
    - Response includes "electronic", "other", and all other genres
  </verify>
  <done>
    GET /api/genres returns the full genre list. The endpoint is self-documenting for AI agents discovering valid genre values.
  </done>
</task>

</tasks>

<verification>
1. D1 has 14 columns in tracks table (9 original + genre, description, tags, file_hash, artist_name)
2. Composite index idx_tracks_wallet_hash exists for duplicate detection
3. @claw/shared exports Track (with all fields), GENRES, Genre, SubmissionError, SubmitResponse
4. GET /api/genres returns valid genre list
5. wrangler.toml has nodejs_compat flag
6. TypeScript compiles cleanly for all workspaces
</verification>

<success_criteria>
- D1 migration applied with all new columns and composite index
- Track type updated with genre, description, tags, fileHash, artistName, coverUrl
- GET /api/genres returns 15 genres including "other"
- wrangler.toml configured with nodejs_compat
- Zero TypeScript compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-submission-pipeline/02-01-SUMMARY.md`
</output>
