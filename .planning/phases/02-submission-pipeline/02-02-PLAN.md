---
phase: 02-submission-pipeline
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - api/src/lib/audio.ts
  - api/src/lib/hash.ts
  - api/src/lib/identicon.ts
  - api/src/lib/image.ts
  - api/src/middleware/validation.ts
  - api/src/middleware/x402.ts
  - api/package.json
autonomous: true

must_haves:
  truths:
    - "MP3 files can be validated by magic number (not client Content-Type) and duration extracted"
    - "Audio files can be hashed with SHA-256 using streaming DigestStream"
    - "Identicons can be generated from wallet addresses as PNG data URLs"
    - "x402 payment verification middleware returns 402 with proper headers when no payment provided"
    - "x402 middleware verifies payment signature against facilitator endpoint"
    - "Validation rejects non-MP3 files, files over 50MB, and audio over 10 minutes with structured error codes"
  artifacts:
    - path: "api/src/lib/audio.ts"
      provides: "MP3 duration extraction from ArrayBuffer"
      exports: ["getAudioDuration"]
    - path: "api/src/lib/hash.ts"
      provides: "SHA-256 file hashing via DigestStream"
      exports: ["hashFile"]
    - path: "api/src/lib/identicon.ts"
      provides: "Wallet address to identicon data URL"
      exports: ["generateIdenticon"]
    - path: "api/src/lib/image.ts"
      provides: "Cover art validation and R2 upload"
      exports: ["processAndUploadCoverArt"]
    - path: "api/src/middleware/validation.ts"
      provides: "Multipart submission validation (file type, size, duration, metadata)"
      exports: ["validateSubmission"]
    - path: "api/src/middleware/x402.ts"
      provides: "x402 payment gate middleware for Hono"
      exports: ["requirePayment"]
  key_links:
    - from: "api/src/middleware/validation.ts"
      to: "api/src/lib/audio.ts"
      via: "Duration extraction call"
      pattern: "getAudioDuration"
    - from: "api/src/middleware/x402.ts"
      to: "https://x402.org/facilitator/verify"
      via: "Fetch to facilitator for payment verification"
      pattern: "fetch.*facilitator.*verify"
---

<objective>
Build the validation library layer, utility functions, and x402 payment middleware that the submit endpoint will depend on.

Purpose: The submit endpoint (Plan 03) needs file validation, duration extraction, hashing, identicon generation, image processing, and payment verification. Building these as independent, testable modules keeps the submit route clean and each concern isolated. These are the building blocks -- Plan 03 wires them into the endpoint.

Output: Six library/middleware files in api/src/lib/ and api/src/middleware/, plus npm dependencies installed
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-submission-pipeline/02-CONTEXT.md
@.planning/phases/02-submission-pipeline/02-RESEARCH.md

# Existing API structure
@api/src/index.ts
@api/package.json
@api/wrangler.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create utility libraries</name>
  <files>
    api/package.json
    api/src/lib/audio.ts
    api/src/lib/hash.ts
    api/src/lib/identicon.ts
    api/src/lib/image.ts
  </files>
  <action>
    1. Install npm packages in the api workspace:
       `cd api && pnpm add file-type get-mp3-duration blockies-ts`

       NOTE: If `get-mp3-duration` has compatibility issues (it's an older package), the fallback approach is to parse MP3 frame headers manually. The research flagged this as MEDIUM confidence. If install fails or types are missing, create a minimal MP3 duration parser that reads the first few MP3 frames to calculate duration (CBR: frame count * frame duration; VBR: check Xing/VBRI header).

    2. Create `api/src/lib/audio.ts`:
       - Export `getAudioDuration(buffer: ArrayBuffer): number` that returns duration in milliseconds
       - Use get-mp3-duration if available, passing the Buffer/ArrayBuffer
       - If get-mp3-duration doesn't work in Workers environment, implement a fallback:
         Read MP3 frame sync bytes (0xFF 0xFB/0xFA/0xF3/0xF2), extract bitrate and sample rate from frame header, calculate duration from file size and bitrate (for CBR) or parse Xing header (for VBR)
       - Throw descriptive error if duration cannot be extracted

    3. Create `api/src/lib/hash.ts`:
       - Export `hashFile(file: File): Promise<string>` that returns SHA-256 hex string
       - Use `crypto.DigestStream('SHA-256')` for streaming hash (do NOT load entire file into memory)
       - Pipe `file.stream()` to the DigestStream
       - Convert resulting ArrayBuffer digest to hex string
       - This is Cloudflare Workers native API, no npm packages needed

    4. Create `api/src/lib/identicon.ts`:
       - Export `generateIdenticon(walletAddress: string): string` that returns a data URL (PNG base64)
       - Use blockies-ts to generate an 8x8 grid identicon seeded with `walletAddress.toLowerCase()`
       - If blockies-ts requires HTMLCanvasElement (browser API not available in Workers), use a fallback approach:
         Generate a deterministic color palette from the wallet address hash, create a simple SVG identicon as a data URL string. The SVG approach works in any runtime without canvas dependencies.
       - The identicon URL will be stored as the cover_url in D1 when no cover art is provided

    5. Create `api/src/lib/image.ts`:
       - Export `processAndUploadCoverArt(imageFile: File, trackId: number, bucket: R2Bucket): Promise<string>` that returns the R2 URL for the stored cover image
       - Validate image type using file-type library (`fileTypeFromBlob`): accept only image/jpeg, image/png, image/webp
       - Validate image size: max 5MB
       - Upload original image to R2 at `covers/{trackId}.{ext}` using `imageFile.stream()` (streaming upload)
       - Set correct Content-Type httpMetadata on the R2 object
       - Return the R2 key path (e.g., `covers/123.jpg`) -- the full URL will be constructed by the caller using the bucket's public URL
       - NOTE: Skip Cloudflare Images API transformation for now (requires Images subscription, billing unclear). Store the original image. Resizing can be added later if needed.
  </action>
  <verify>
    - `cd api && pnpm exec tsc --noEmit` passes (all lib files compile)
    - api/package.json shows file-type, get-mp3-duration, blockies-ts in dependencies
    - All four lib files exist and export their named functions
  </verify>
  <done>
    Four utility libraries created: audio duration extraction, streaming file hashing, identicon generation, and cover art processing. All compile without TypeScript errors. npm dependencies installed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Validation helper and x402 payment middleware</name>
  <files>
    api/src/middleware/validation.ts
    api/src/middleware/x402.ts
  </files>
  <action>
    1. Create `api/src/middleware/validation.ts`:
       - Import `fileTypeFromBlob` from file-type
       - Import `getAudioDuration` from `../lib/audio`
       - Import `GENRES` from `@claw/shared`

       Export `validateSubmission` function that takes the parsed multipart body and returns a structured result:

       ```typescript
       interface ValidationResult {
         valid: boolean
         errorCode?: string
         message?: string
         field?: string
         data?: {
           title: string
           genre: string
           description?: string
           tags?: string[]
           audioFile: File
           audioSize: number
           audioDuration: number  // milliseconds
           imageFile?: File
         }
       }
       ```

       Validation order (return first error found):
       a. Check `audio` field exists and is a File -- error: MISSING_AUDIO
       b. Check `title` field exists, is non-empty string, max 200 chars -- errors: MISSING_TITLE, TITLE_TOO_LONG
       c. Check `genre` field exists and is in GENRES array -- errors: MISSING_GENRE, INVALID_GENRE
       d. Validate audio file type via magic number (fileTypeFromBlob): must be audio/mpeg -- error: INVALID_AUDIO_TYPE
       e. Validate audio file size: max 50MB (50 * 1024 * 1024 bytes) -- error: FILE_TOO_LARGE
       f. Extract audio duration using getAudioDuration: max 10 minutes (600000ms) -- error: DURATION_TOO_LONG
       g. If `image` field is a File, validate image type (jpeg/png/webp via fileTypeFromBlob) and size (max 5MB) -- errors: INVALID_IMAGE_TYPE, IMAGE_TOO_LARGE
       h. Parse `tags` field if present: expect comma-separated string or JSON array string, max 10 tags, each max 50 chars -- error: INVALID_TAGS
       i. `description` is optional, max 1000 chars -- error: DESCRIPTION_TOO_LONG

       Each error response includes: `{ error: errorCode, message: humanReadableMessage, field: fieldName }`

    2. Create `api/src/middleware/x402.ts`:
       - Export `requirePayment` as a Hono middleware factory using `createMiddleware` from `hono/factory`

       The middleware:
       a. Checks for `X-PAYMENT` header (x402 payment signature). Note: Research mentions both PAYMENT-SIGNATURE and X-PAYMENT headers. Check for both, preferring X-PAYMENT as the x402 standard.
       b. If no payment header present, return 402 with JSON body and `X-PAYMENT-REQUIRED` header:
          ```json
          {
            "error": "PAYMENT_REQUIRED",
            "message": "Payment of 0.01 USDC required to submit track",
            "paymentRequirements": {
              "scheme": "exact",
              "network": "eip155:8453",
              "asset": "0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913",
              "maxAmountRequired": "10000",
              "resource": "/api/submit",
              "description": "Track submission fee"
            }
          }
          ```
          Also set header: `X-PAYMENT-REQUIRED: <base64-encoded paymentRequirements>`
       c. If payment header present, verify with facilitator:
          POST to `https://x402.org/facilitator/verify` with the payment payload and requirements
          - On success: extract wallet address from facilitator response, store it on context via `c.set('walletAddress', address)`, call `await next()`
          - On failure: return 402 with error code PAYMENT_INVALID
       d. The `payTo` address comes from `c.env.PLATFORM_WALLET` environment variable

       Type the Hono env to include PLATFORM_WALLET:
       ```typescript
       type PaymentEnv = {
         Bindings: { PLATFORM_WALLET: string }
         Variables: { walletAddress: string }
       }
       ```

       IMPORTANT: The middleware is NOT applied globally. It will be called manually within the submit route AFTER validation passes (validate-first-then-charge pattern). So export it as a callable function, not as Hono middleware that auto-applies. The function signature should be:

       `verifyPayment(c: Context): Promise<{ valid: boolean; walletAddress?: string; error?: Response }>`

       This way the submit route can call it after validation and get back either a wallet address or an error response to return.
  </action>
  <verify>
    - `cd api && pnpm exec tsc --noEmit` passes (middleware files compile)
    - Both files exist and export their named functions
    - validation.ts imports from lib/audio and @claw/shared
    - x402.ts uses proper x402 header names and facilitator URL
  </verify>
  <done>
    Validation helper validates file type (magic number), file size (50MB), duration (10min), metadata fields (title, genre, tags, description), and image (type + size). x402 payment verifier checks payment header, verifies with facilitator, and extracts wallet address. Both return structured results for the submit endpoint to consume.
  </done>
</task>

</tasks>

<verification>
1. `pnpm --filter claw-fm-api exec tsc --noEmit` passes with all new files
2. api/src/lib/ contains audio.ts, hash.ts, identicon.ts, image.ts
3. api/src/middleware/ contains validation.ts, x402.ts
4. file-type, get-mp3-duration, blockies-ts in api/package.json dependencies
5. Each module has a clear single responsibility and typed exports
</verification>

<success_criteria>
- All six library/middleware files compile without TypeScript errors
- npm dependencies installed: file-type, get-mp3-duration, blockies-ts
- Validation covers: file type (magic number), size (50MB), duration (10min), metadata, image
- x402 verifier handles: missing payment (402 response), payment verification (facilitator call), wallet extraction
- Utility libs handle: duration extraction, streaming hash, identicon generation, image upload
</success_criteria>

<output>
After completion, create `.planning/phases/02-submission-pipeline/02-02-SUMMARY.md`
</output>
