---
phase: 02-submission-pipeline
plan: 04
type: execute
wave: 1
depends_on: ["02-03"]
files_modified:
  - api/src/middleware/x402.ts
  - api/src/routes/submit.ts
  - api/package.json
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "x402 payment verification uses @openfacilitator/sdk, not raw fetch to x402.org"
    - "Payment is both verified AND settled via the SDK before proceeding"
    - "402 responses still include payment requirements in X-PAYMENT-REQUIRED header"
    - "Wallet address is correctly extracted from the SDK verify/settle response"
    - "No dead imports exist in submit.ts"
  artifacts:
    - path: "api/src/middleware/x402.ts"
      provides: "x402 payment verification via @openfacilitator/sdk"
      contains: "OpenFacilitator"
    - path: "api/src/routes/submit.ts"
      provides: "Submit endpoint with clean imports"
    - path: "api/package.json"
      provides: "@openfacilitator/sdk dependency"
      contains: "@openfacilitator/sdk"
  key_links:
    - from: "api/src/middleware/x402.ts"
      to: "@openfacilitator/sdk"
      via: "OpenFacilitator.verify() and OpenFacilitator.settle()"
      pattern: "facilitator\\.(verify|settle)"
    - from: "api/src/routes/submit.ts"
      to: "api/src/middleware/x402.ts"
      via: "verifyPayment import"
      pattern: "import.*verifyPayment.*x402"
---

<objective>
Close 2 verification gaps from Phase 02 VERIFICATION.md:

1. Replace manual `fetch` to `https://x402.org/facilitator/verify` in x402.ts with `@openfacilitator/sdk` (user directive: use @openfacilitator/sdk not x402.org/facilitator)
2. Remove dead `hashFile` import from submit.ts

The track key format (timestamp-UUID) was flagged as PARTIAL but is acceptable -- the verification report itself notes "both approaches work" and the timestamp-UUID provides better uniqueness. No code change needed; this plan documents the acceptance.

Purpose: Fix the core payment integration to use the correct facilitator SDK, clean up dead code, and close all verification gaps so Phase 02 can be marked complete.

Output: Updated x402.ts using @openfacilitator/sdk, cleaned submit.ts, updated package.json with SDK dependency.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-submission-pipeline/02-VERIFICATION.md
@.planning/phases/02-submission-pipeline/02-03-SUMMARY.md
@api/src/middleware/x402.ts
@api/src/routes/submit.ts
@api/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace x402.org fetch with @openfacilitator/sdk</name>
  <files>api/package.json, api/src/middleware/x402.ts</files>
  <action>
**Step 1: Install the SDK**

Run `pnpm add @openfacilitator/sdk --filter claw-fm-api` to add the dependency.

**Step 2: Rewrite api/src/middleware/x402.ts**

Replace the entire file. The new implementation must:

1. Import `OpenFacilitator` and `PaymentRequirementsV1` from `@openfacilitator/sdk`.

2. Keep the existing `PaymentVerificationResult` interface (used by submit.ts):
   ```typescript
   export interface PaymentVerificationResult {
     valid: boolean
     walletAddress?: string
     error?: Response
   }
   ```

3. Keep the same `verifyPayment(c: Context)` function signature so submit.ts does not need changes to its call site.

4. Inside `verifyPayment`:

   a. Read the payment header from `X-PAYMENT` or `x-payment` (case-insensitive via `c.req.header()`). Do NOT check `PAYMENT-SIGNATURE` -- x402 standard uses `X-PAYMENT`.

   b. Define payment requirements as `PaymentRequirementsV1` type from the SDK:
      ```typescript
      const requirements: PaymentRequirementsV1 = {
        scheme: 'exact',
        network: 'base',
        maxAmountRequired: '10000', // 0.01 USDC (6 decimals)
        asset: '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913', // USDC on Base
        resource: '/api/submit',
        description: 'Track submission fee',
        payTo: c.env.PLATFORM_WALLET as string,
      }
      ```
      Note: Use `network: 'base'` (v1 human-readable format), NOT `'eip155:8453'`. The SDK handles v1/v2 translation internally.

   c. If no payment header: Return 402 with `X-PAYMENT-REQUIRED` header containing base64-encoded requirements JSON. Keep the same response shape as current code (error code `PAYMENT_REQUIRED`, message about 0.01 USDC, paymentRequirements in body).

   d. If payment header present:
      - Parse it: The X-PAYMENT header contains a base64-encoded JSON string. Decode it: `const paymentPayload = JSON.parse(atob(paymentHeader))`
      - Create facilitator instance: `const facilitator = new OpenFacilitator()` (defaults to https://pay.openfacilitator.io)
      - Call verify: `const verifyResult = await facilitator.verify(paymentPayload, requirements)`
      - Check `verifyResult.isValid` (NOT `.valid` -- SDK uses `isValid`). If not valid, return 402 with `PAYMENT_INVALID` error and include `verifyResult.invalidReason` in the message.
      - If valid, call settle: `const settleResult = await facilitator.settle(paymentPayload, requirements)`
      - Check `settleResult.success`. If not successful, return 402 with `PAYMENT_SETTLEMENT_FAILED` error and include `settleResult.errorReason`.
      - If settled successfully, return `{ valid: true, walletAddress: settleResult.payer }`. The `payer` field from `SettleResponse` is the wallet address that paid.

   e. Wrap the verify/settle calls in try-catch. Import `FacilitatorError` from the SDK. In the catch block:
      - If `error instanceof FacilitatorError`, return 502 with `FACILITATOR_ERROR` code and include `error.message`.
      - Otherwise return 500 with `PAYMENT_VERIFICATION_ERROR` and the error message (same as current behavior).

**Important details:**
- Do NOT use `createDefaultFacilitator()` -- it's deprecated per the SDK types. Use `new OpenFacilitator()` directly.
- Do NOT use `honoPaymentMiddleware()` -- the current architecture calls verifyPayment manually from submit.ts after validation passes (validate-first-then-charge pattern). Changing to middleware would require restructuring the submit route, which is unnecessary for gap closure.
- The `OpenFacilitator` constructor with no args defaults to `https://pay.openfacilitator.io`. This is correct.
- Remove the old `PaymentRequirements` interface from the file -- use `PaymentRequirementsV1` from the SDK instead.
  </action>
  <verify>
1. Run `pnpm --filter claw-fm-api exec tsc --noEmit` -- must compile with zero errors
2. Grep for `x402.org` in the entire api/src directory -- must return zero results
3. Grep for `OpenFacilitator` in api/src/middleware/x402.ts -- must find at least one match
4. Grep for `facilitator.verify` in api/src/middleware/x402.ts -- must find at least one match
5. Grep for `facilitator.settle` in api/src/middleware/x402.ts -- must find at least one match
6. Run `pnpm --filter claw-fm-api exec wrangler dev --test-scheduled` briefly (or just typecheck) to confirm no runtime import issues
  </verify>
  <done>
x402.ts uses `@openfacilitator/sdk` OpenFacilitator class for both verify and settle. No references to x402.org remain. The `verifyPayment` function signature is unchanged so submit.ts works without modification. Payment requirements use SDK's PaymentRequirementsV1 type with `network: 'base'`. 402 responses still include X-PAYMENT-REQUIRED header with base64 requirements. Wallet address extracted from `settleResult.payer`.
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove dead import and verify full build</name>
  <files>api/src/routes/submit.ts</files>
  <action>
**Step 1: Remove dead hashFile import from submit.ts**

In `api/src/routes/submit.ts`, line 5 currently reads:
```typescript
import { hashFile } from '../lib/hash'
```

Remove this entire line. The file uses `crypto.subtle.digest` inline (line 44) for hashing, so `hashFile` is never called.

**Step 2: Verify no other usages of hashFile exist**

Grep the codebase for any imports of `hashFile` from `lib/hash`. If submit.ts was the only consumer and hash.ts is now unused, leave hash.ts in place -- it may be useful later and removing utility files is out of scope for gap closure.

**Step 3: Full build verification**

Run the full typecheck to confirm:
- x402.ts compiles with SDK types
- submit.ts compiles without the hashFile import
- No other type errors introduced

**Step 4: Smoke test the dev server**

Start `pnpm --filter claw-fm-api exec wrangler dev` briefly and test:
- `GET /health` returns 200
- `GET /api/genres` returns 200
- `POST /api/submit` with no body returns 400 (validation error, not crash)
- `POST /api/submit` with a valid MP3 file and title but no payment header returns 402 with payment requirements in X-PAYMENT-REQUIRED header

Stop the dev server after verification.
  </action>
  <verify>
1. Run `pnpm --filter claw-fm-api exec tsc --noEmit` -- zero errors
2. Grep for `hashFile` in api/src/routes/submit.ts -- must return zero results
3. Start wrangler dev, test `GET /health` returns 200
4. Test `POST /api/submit` with empty body returns 400
5. Test `POST /api/submit` with valid MP3 + title (no payment) returns 402 with X-PAYMENT-REQUIRED header
  </verify>
  <done>
Dead `hashFile` import removed from submit.ts. Full TypeScript compilation passes. Dev server starts and all existing endpoints respond correctly. The 402 payment required flow works with the new SDK-based x402.ts (no-payment case returns proper requirements). No regressions in validation error handling.
  </done>
</task>

</tasks>

<decisions>
**Track key format (timestamp-UUID):** Accepted as-is. The verification report flagged this as PARTIAL but noted "both approaches work" and "UUID provides better uniqueness." The `tracks/${Date.now()}-${crypto.randomUUID()}.mp3` format is superior to `tracks/${trackId}.mp3` because: (1) trackId is an auto-increment integer only known after D1 INSERT, requiring a rename or pre-allocation; (2) timestamp-UUID avoids race conditions; (3) sequential integer keys in R2 are an anti-pattern for partitioning. No code change needed. This is documented as an accepted decision.
</decisions>

<verification>
After both tasks complete:

1. **No x402.org references:** `grep -r "x402.org" api/src/` returns nothing
2. **SDK in use:** `grep -r "OpenFacilitator" api/src/` finds x402.ts
3. **Clean imports:** `grep "hashFile" api/src/routes/submit.ts` returns nothing
4. **SDK installed:** `grep "@openfacilitator/sdk" api/package.json` finds the dependency
5. **TypeScript clean:** `pnpm --filter claw-fm-api exec tsc --noEmit` passes
6. **Dev server functional:** Health check, genres, and submit validation/payment flows work
7. **Verify + settle pattern:** `grep -E "facilitator\.(verify|settle)" api/src/middleware/x402.ts` finds both calls
</verification>

<success_criteria>
1. `api/src/middleware/x402.ts` uses `@openfacilitator/sdk` OpenFacilitator class (verify + settle) instead of raw fetch to x402.org
2. `api/src/routes/submit.ts` has no dead imports (hashFile removed)
3. `api/package.json` includes `@openfacilitator/sdk` as a dependency
4. TypeScript compilation passes with zero errors
5. Dev server starts and all three endpoints (/health, /api/genres, /api/submit) respond correctly
6. All verification gaps from 02-VERIFICATION.md are closed
</success_criteria>

<output>
After completion, create `.planning/phases/02-submission-pipeline/02-04-SUMMARY.md`
</output>
