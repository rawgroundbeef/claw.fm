---
phase: 07-schema-api
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - api/migrations/0003_artist-profiles.sql
  - packages/shared/src/index.ts
  - api/src/index.ts
  - api/wrangler.toml
autonomous: true

must_haves:
  truths:
    - "artist_profiles table exists with wallet (UNIQUE), username (UNIQUE COLLATE NOCASE), display_name, bio, avatar_url, created_at, updated_at columns"
    - "Shared package exports Zod schemas for username and profile validation"
    - "Shared package exports TypeScript types for ArtistProfile and all API response shapes"
    - "Reserved username blocklist rejects system route names"
    - "All new route files are wired into the Hono app in api/src/index.ts"
  artifacts:
    - path: "api/migrations/0003_artist-profiles.sql"
      provides: "D1 migration creating artist_profiles table"
      contains: "CREATE TABLE.*artist_profiles"
    - path: "packages/shared/src/index.ts"
      provides: "Zod schemas, profile types, and reserved word blocklist"
      exports: ["UsernameSchema", "ProfileUpdateSchema", "ArtistProfile", "ProfileResponse", "UsernameAvailableResponse", "RESERVED_USERNAMES"]
    - path: "api/src/index.ts"
      provides: "Route wiring for profile, artist, username, and avatar endpoints"
      contains: "app.route.*api/profile"
  key_links:
    - from: "packages/shared/src/index.ts"
      to: "api/src/routes/profile.ts"
      via: "Zod schema import for validation"
      pattern: "import.*ProfileUpdateSchema.*@claw/shared"
    - from: "api/migrations/0003_artist-profiles.sql"
      to: "api/src/routes/profile.ts"
      via: "D1 table referenced in SQL queries"
      pattern: "artist_profiles"
---

<objective>
Create the artist_profiles database schema, shared TypeScript types with Zod validation schemas, and wire all new route stubs into the API entry point.

Purpose: This is the foundation for all Phase 7 work. The migration creates the table, shared types ensure API contract consistency between API and frontend, and route wiring lets Plans 02 and 03 implement route logic without touching index.ts.

Output: D1 migration file, extended shared package with profile types/schemas, updated API entry point with all v1.1 routes wired.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-schema-api/07-CONTEXT.md
@.planning/phases/07-schema-api/07-RESEARCH.md
@api/migrations/0001_tracks-schema.sql
@api/migrations/0002_submission-fields.sql
@packages/shared/src/index.ts
@api/src/index.ts
@api/wrangler.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: D1 migration and shared types with Zod validation</name>
  <files>
    api/migrations/0003_artist-profiles.sql
    packages/shared/src/index.ts
  </files>
  <action>
**Migration file** (`api/migrations/0003_artist-profiles.sql`):

Create the `artist_profiles` table with these columns:
- `id` INTEGER PRIMARY KEY AUTOINCREMENT
- `wallet` TEXT NOT NULL UNIQUE -- one profile per wallet
- `username` TEXT NOT NULL UNIQUE COLLATE NOCASE -- case-insensitive uniqueness
- `display_name` TEXT NOT NULL -- free-text, max 50 chars (enforced at API layer)
- `bio` TEXT -- optional, max 280 chars (enforced at API layer)
- `avatar_url` TEXT -- R2 key for avatar image, NULL means identicon fallback
- `created_at` INTEGER NOT NULL DEFAULT (unixepoch())
- `updated_at` INTEGER NOT NULL DEFAULT (unixepoch())

Add indexes:
- `CREATE UNIQUE INDEX idx_artist_username ON artist_profiles(username COLLATE NOCASE)` -- explicit COLLATE on index
- `CREATE INDEX idx_artist_wallet ON artist_profiles(wallet)` -- wallet lookups

IMPORTANT: COLLATE NOCASE must be on the column definition itself, not just the index. This ensures all queries against the column use case-insensitive comparison.

**Shared types** (`packages/shared/src/index.ts`):

Add Zod as a dependency first. The shared package currently has NO dependencies -- add `zod` to `packages/shared/package.json`.

Then add to the existing `packages/shared/src/index.ts` (append, do not replace existing exports):

1. Import Zod at the top of the file.

2. `RESERVED_USERNAMES` constant -- array of strings that cannot be used as usernames. Include: `admin`, `api`, `artist`, `artists`, `audio`, `browse`, `claw`, `dashboard`, `downloads`, `explore`, `feed`, `genres`, `health`, `help`, `home`, `login`, `logout`, `now-playing`, `official`, `play`, `profile`, `queue`, `radio`, `search`, `settings`, `signup`, `submit`, `support`, `tip`, `verified`. Export it as `const`.

3. `UsernameSchema` -- Zod schema:
   - `z.string()`
   - `.min(3, 'Username must be at least 3 characters')`
   - `.max(20, 'Username must be 20 characters or less')`
   - `.regex(/^[a-z0-9][a-z0-9_]*[a-z0-9]$/, 'Username must be lowercase alphanumeric or underscores, cannot start or end with underscore')` -- NOTE: this regex requires min 2 chars, but `.min(3)` catches that. For exactly 3 chars like "abc" this works. For single-char usernames blocked by min(3).
   - `.refine((val) => !RESERVED_USERNAMES.includes(val), { message: 'This username is reserved' })`

4. `ProfileUpdateSchema` -- Zod schema:
   - `username`: UsernameSchema
   - `displayName`: `z.string().min(1, 'Display name is required').max(50, 'Display name must be 50 characters or less')`
   - `bio`: `z.string().max(280, 'Bio must be 280 characters or less').optional()`

5. Inferred types:
   - `export type ProfileUpdate = z.infer<typeof ProfileUpdateSchema>`

6. `ArtistProfile` interface:
   ```typescript
   export interface ArtistProfile {
     id: number
     wallet: string
     username: string
     displayName: string
     bio: string | null
     avatarUrl: string | null
     createdAt: number
     updatedAt: number
   }
   ```

7. API response types:
   ```typescript
   export interface ProfileResponse {
     profile: ArtistProfile
   }

   export interface ProfileError {
     error: string
     message: string
     field?: string
   }

   export interface UsernameAvailableResponse {
     username: string
     available: boolean
   }

   export interface ArtistPublicProfile {
     username: string
     displayName: string
     bio: string | null
     avatarUrl: string | null
     wallet: string
     createdAt: number
   }

   export interface ArtistProfileWithTracks {
     profile: ArtistPublicProfile
     tracks: Track[]  // Reuse existing Track interface
   }
   ```

IMPORTANT: Also update `packages/shared/package.json` to add `"zod": "^3.24.0"` as a dependency. Note: Research says Zod 4.3.6 but that version doesn't exist yet (Zod v4 is not released as of the knowledge cutoff). Use Zod v3 (latest stable: `^3.24.0`). The API patterns from research (z.string(), z.object(), z.infer) work identically in Zod v3.
  </action>
  <verify>
Run `pnpm install` from the workspace root to install Zod dependency. Then run `npx tsc --noEmit -p packages/shared/tsconfig.json` to verify shared types compile. Verify the migration SQL is valid by checking syntax (no runtime check needed -- D1 applies it on deploy).
  </verify>
  <done>
Migration file `0003_artist-profiles.sql` exists with correct schema. Shared package exports `UsernameSchema`, `ProfileUpdateSchema`, `ArtistProfile`, `ProfileResponse`, `ProfileError`, `UsernameAvailableResponse`, `ArtistPublicProfile`, `ArtistProfileWithTracks`, and `RESERVED_USERNAMES`. All types compile without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire new route stubs into API entry point</name>
  <files>
    api/src/index.ts
    api/src/routes/profile.ts
    api/src/routes/artist.ts
    api/src/routes/username.ts
    api/src/routes/avatar.ts
  </files>
  <action>
Create minimal stub route files that Plans 02 and 03 will implement. Each stub exports a Hono route that returns 501 Not Implemented. This allows wiring everything into index.ts now so Plans 02 and 03 don't have file conflicts on index.ts.

**Stub files** (create 4 new files):

`api/src/routes/profile.ts`:
```typescript
import { Hono } from 'hono'

type Env = {
  Bindings: {
    DB: D1Database
    AUDIO_BUCKET: R2Bucket
    PLATFORM_WALLET: string
    KV: KVNamespace
  }
}

const profileRoute = new Hono<Env>()

profileRoute.put('/', async (c) => {
  return c.json({ error: 'NOT_IMPLEMENTED', message: 'Profile creation coming soon' }, 501)
})

export default profileRoute
```

`api/src/routes/artist.ts`:
```typescript
import { Hono } from 'hono'

type Env = {
  Bindings: {
    DB: D1Database
  }
}

const artistRoute = new Hono<Env>()

artistRoute.get('/:username', async (c) => {
  return c.json({ error: 'NOT_IMPLEMENTED', message: 'Artist lookup coming soon' }, 501)
})

artistRoute.get('/by-wallet/:wallet', async (c) => {
  return c.json({ error: 'NOT_IMPLEMENTED', message: 'Wallet lookup coming soon' }, 501)
})

export default artistRoute
```

`api/src/routes/username.ts`:
```typescript
import { Hono } from 'hono'

type Env = {
  Bindings: {
    DB: D1Database
  }
}

const usernameRoute = new Hono<Env>()

usernameRoute.get('/:username/available', async (c) => {
  return c.json({ error: 'NOT_IMPLEMENTED', message: 'Username check coming soon' }, 501)
})

export default usernameRoute
```

`api/src/routes/avatar.ts`:
```typescript
import { Hono } from 'hono'

type Env = {
  Bindings: {
    DB: D1Database
    AUDIO_BUCKET: R2Bucket
    PLATFORM_WALLET: string
  }
}

const avatarRoute = new Hono<Env>()

avatarRoute.post('/', async (c) => {
  return c.json({ error: 'NOT_IMPLEMENTED', message: 'Avatar upload coming soon' }, 501)
})

export default avatarRoute
```

**Wire into `api/src/index.ts`**:

Add imports for the 4 new route files alongside existing route imports. Add route registrations:
```typescript
app.route('/api/profile', profileRoute)
app.route('/api/artist', artistRoute)
app.route('/api/username', usernameRoute)
app.route('/api/avatar', avatarRoute)
```

Place these after the existing `app.route('/api/tip', tipRoute)` line.

Do NOT modify or remove any existing routes or code in index.ts. Only add the new imports and route registrations.
  </action>
  <verify>
Run `npx tsc --noEmit -p api/tsconfig.json` to verify the API compiles with all stubs wired. Run `npx wrangler dev --port 8787` briefly and test: `curl http://localhost:8787/api/profile -X PUT` should return 501 JSON. `curl http://localhost:8787/api/artist/testuser` should return 501 JSON. `curl http://localhost:8787/api/username/testuser/available` should return 501 JSON. `curl http://localhost:8787/api/avatar -X POST` should return 501 JSON. Existing endpoints (`/health`, `/api/now-playing`) should still work normally.
  </verify>
  <done>
Four stub route files exist. All routes wired in index.ts. API compiles. All new endpoints return 501. All existing endpoints unaffected.
  </done>
</task>

</tasks>

<verification>
1. `api/migrations/0003_artist-profiles.sql` exists and contains valid CREATE TABLE with COLLATE NOCASE on username column
2. `packages/shared/src/index.ts` exports all profile-related Zod schemas and TypeScript types
3. `api/src/index.ts` imports and registers all 4 new route files
4. `npx tsc --noEmit -p api/tsconfig.json` passes (API compiles)
5. All existing routes still respond normally
</verification>

<success_criteria>
- Migration creates `artist_profiles` table with correct column types, constraints, and COLLATE NOCASE
- Shared package exports `UsernameSchema`, `ProfileUpdateSchema`, `ArtistProfile`, `ProfileResponse`, `ProfileError`, `UsernameAvailableResponse`, `ArtistPublicProfile`, `ArtistProfileWithTracks`, `RESERVED_USERNAMES`
- All 4 stub routes wired and responding with 501
- TypeScript compilation succeeds for both shared and api packages
</success_criteria>

<output>
After completion, create `.planning/phases/07-schema-api/07-01-SUMMARY.md`
</output>
