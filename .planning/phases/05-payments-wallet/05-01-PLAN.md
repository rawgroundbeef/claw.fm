---
phase: 05-payments-wallet
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - web/package.json
  - web/src/lib/wagmi.ts
  - web/src/lib/constants.ts
  - web/src/main.tsx
  - web/src/components/WalletDisplay.tsx
  - web/src/App.tsx
autonomous: true

must_haves:
  truths:
    - "App renders inside WagmiProvider, QueryClientProvider, and OnchainKitProvider"
    - "Toaster from Sonner is rendered and available for toast() calls anywhere in the app"
    - "Wallet connect button appears in the UI and triggers Smart Wallet creation on click"
    - "Connected wallet address and USDC balance are visible in the header area"
    - "All existing player functionality still works (no regressions from provider wrapping)"
    - "Smart Wallet is created on-demand during first payment transaction (no explicit connect required) via coinbaseWallet connector with smartWalletOnly preference"
  artifacts:
    - path: "web/src/lib/wagmi.ts"
      provides: "Wagmi config with Base chain and coinbaseWallet connector"
      exports: ["config", "queryClient"]
    - path: "web/src/lib/constants.ts"
      provides: "USDC address, platform wallet, tip amounts, buy price, ERC20 ABI fragment"
      exports: ["USDC_ADDRESS", "PLATFORM_WALLET", "TIP_AMOUNTS", "BUY_PRICE_USDC", "ERC20_TRANSFER_ABI"]
    - path: "web/src/components/WalletDisplay.tsx"
      provides: "Wallet connection button and address/balance display"
      exports: ["WalletDisplay"]
    - path: "web/src/main.tsx"
      provides: "App wrapped with WagmiProvider, QueryClientProvider, OnchainKitProvider, Toaster"
  key_links:
    - from: "web/src/main.tsx"
      to: "web/src/lib/wagmi.ts"
      via: "import config and queryClient"
      pattern: "import.*wagmi"
    - from: "web/src/components/WalletDisplay.tsx"
      to: "wagmi hooks"
      via: "useAccount, useBalance"
      pattern: "useAccount|useBalance"
    - from: "web/src/App.tsx"
      to: "web/src/components/WalletDisplay.tsx"
      via: "import and render in header"
      pattern: "WalletDisplay"
    - from: "web/src/lib/wagmi.ts"
      to: "coinbaseWallet connector"
      via: "smartWalletOnly preference enables on-demand wallet creation"
      pattern: "smartWalletOnly"
---

<objective>
Set up Web3 provider infrastructure (OnchainKit + Wagmi + TanStack Query), install all payment-related dependencies, create wallet connection UI, and display connected wallet address with USDC balance.

Purpose: Every payment action (tip, buy) requires a connected wallet. This plan establishes the provider hierarchy and wallet UI that all subsequent payment plans depend on. The coinbaseWallet connector with `smartWalletOnly` preference ensures a Smart Wallet is created on-demand during the first payment interaction (PAY-03) -- no separate wallet creation step is needed.
Output: Working wallet connection flow with address/balance display, Sonner toast system ready, all payment libraries installed.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-payments-wallet/05-CONTEXT.md
@.planning/phases/05-payments-wallet/05-RESEARCH.md

@web/src/main.tsx
@web/src/App.tsx
@web/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create wagmi config + payment constants</name>
  <files>
    web/package.json
    web/src/lib/wagmi.ts
    web/src/lib/constants.ts
  </files>
  <action>
Install web dependencies:
```bash
cd web && pnpm add @coinbase/onchainkit wagmi viem @tanstack/react-query sonner react-canvas-confetti
```

Create `web/src/lib/wagmi.ts`:
- Import `createConfig`, `http` from wagmi
- Import `coinbaseWallet` from `wagmi/connectors`
- Import `base` from `wagmi/chains`
- Import `QueryClient` from @tanstack/react-query
- Create wagmi config with:
  - chains: [base]
  - connectors: [coinbaseWallet({ appName: 'claw.fm', preference: 'smartWalletOnly' })]
  - transports: { [base.id]: http() }
- Export `config` and `queryClient` (new QueryClient())

The `smartWalletOnly` preference is critical for PAY-03: it ensures a Coinbase Smart Wallet is created automatically on-demand when the user first interacts with a payment action (writeContract call). No separate "create wallet" step is required.

Create `web/src/lib/constants.ts`:
- `USDC_ADDRESS = '0x833589fcd6edb6e08f4c7c32d4f71b54bda02913'` (Base mainnet USDC)
- `PLATFORM_WALLET` = read from env `import.meta.env.VITE_PLATFORM_WALLET` with fallback to `'0x0000000000000000000000000000000000000000'`
- `TIP_AMOUNTS = [0.25, 1, 5] as const` (USDC amounts)
- `BUY_PRICE_USDC = 2` (fixed $2 per track)
- `USDC_DECIMALS = 6`
- `ERC20_TRANSFER_ABI` - minimal ABI fragment for the `transfer(address,uint256)` function only:
  ```typescript
  export const ERC20_TRANSFER_ABI = [
    {
      name: 'transfer',
      type: 'function',
      stateMutability: 'nonpayable',
      inputs: [
        { name: 'to', type: 'address' },
        { name: 'value', type: 'uint256' },
      ],
      outputs: [{ name: '', type: 'bool' }],
    },
  ] as const
  ```

Do NOT use `erc20Abi` from viem (imports the entire ABI). Use the minimal fragment above.
  </action>
  <verify>
`pnpm --filter claw-fm-web build` succeeds (or `cd web && pnpm tsc --noEmit` for type check). Confirm wagmi.ts and constants.ts have no type errors. Grep wagmi.ts for `smartWalletOnly` to confirm on-demand wallet creation is configured.
  </verify>
  <done>
wagmi config exports config and queryClient with smartWalletOnly preference (PAY-03: wallet created on-demand during first payment). constants.ts exports USDC_ADDRESS, PLATFORM_WALLET, TIP_AMOUNTS, BUY_PRICE_USDC, USDC_DECIMALS, ERC20_TRANSFER_ABI. All dependencies installed in web/package.json.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wrap app with Web3 providers and Sonner Toaster</name>
  <files>web/src/main.tsx</files>
  <action>
Update `web/src/main.tsx` to wrap the App component with the provider hierarchy:

```typescript
import { StrictMode } from 'react'
import { createRoot } from 'react-dom/client'
import { WagmiProvider } from 'wagmi'
import { QueryClientProvider } from '@tanstack/react-query'
import { OnchainKitProvider } from '@coinbase/onchainkit'
import { base } from 'wagmi/chains'
import { Toaster } from 'sonner'
import { config, queryClient } from './lib/wagmi'
import App from './App'
import './index.css'
```

Provider nesting order (outermost to innermost):
1. StrictMode
2. WagmiProvider (config={config})
3. QueryClientProvider (client={queryClient})
4. OnchainKitProvider (chain={base}) -- no apiKey needed for basic wallet functionality
5. App
6. Toaster (sibling to App, position="bottom-right", richColors)

The OnchainKitProvider apiKey prop is optional. Omit it for now -- basic wallet connection and transaction signing work without it. Only advanced features (identity resolution, gas estimation) require it.

Important: Keep the existing StrictMode wrapping. The Toaster component should be a sibling of App inside the providers, not a child of App.
  </action>
  <verify>
`cd web && pnpm run dev` starts without errors. Open browser console -- no provider-related warnings. React DevTools shows provider hierarchy.
  </verify>
  <done>
main.tsx wraps App with WagmiProvider > QueryClientProvider > OnchainKitProvider. Toaster rendered alongside App. Dev server starts without errors.
  </done>
</task>

<task type="auto">
  <name>Task 3: WalletDisplay component wired into App.tsx header</name>
  <files>
    web/src/components/WalletDisplay.tsx
    web/src/App.tsx
  </files>
  <action>
Create `web/src/components/WalletDisplay.tsx`:
- Import `useAccount`, `useConnect`, `useDisconnect`, `useBalance` from wagmi
- Import `USDC_ADDRESS` from '../lib/constants'
- Import `coinbaseWallet` from 'wagmi/connectors'

Component logic:
- Use `useAccount()` to get `address`, `isConnected`
- Use `useBalance({ address, token: USDC_ADDRESS })` to get USDC balance (only when connected)
- Use `useConnect()` with `coinbaseWallet({ appName: 'claw.fm', preference: 'smartWalletOnly' })` connector
- Use `useDisconnect()` for disconnect

When NOT connected: Show a "Connect Wallet" button styled with Tailwind (small, subtle, fits in header area). Use `connect({ connector: coinbaseWallet({ appName: 'claw.fm', preference: 'smartWalletOnly' }) })` on click.

When connected: Show truncated address (first 6 + last 4 chars, e.g. "0x1234...5678") and USDC balance formatted to 2 decimal places (e.g. "12.50 USDC"). Click on address shows disconnect option.

Styling: Small, clean, fits in a header row. Use `text-sm`, `text-gray-600`, pill-shaped background for address.

Update `web/src/App.tsx`:
- Import WalletDisplay
- Add WalletDisplay to the header area, positioned to the right of the "claw.fm" title. Change the header `div` from `mb-8` to a flex row:
  ```tsx
  <div className="w-full max-w-2xl flex items-center justify-between mb-8">
    <h1 className="text-sm font-medium text-gray-400 tracking-widest uppercase">
      claw.fm
    </h1>
    <WalletDisplay />
  </div>
  ```

Do NOT change any other part of App.tsx. Keep all existing player functionality intact.
  </action>
  <verify>
`cd web && pnpm run build` succeeds. Dev server shows "claw.fm" header on left, "Connect Wallet" button on right. Clicking "Connect Wallet" triggers Coinbase Smart Wallet flow (or shows wallet creation prompt).
  </verify>
  <done>
WalletDisplay component renders connect button when disconnected, address + USDC balance when connected. Component is visible in App.tsx header area. All existing player functionality unchanged.
  </done>
</task>

</tasks>

<verification>
1. `cd web && pnpm run build` succeeds with no TypeScript errors
2. Dev server starts and renders existing player UI without regressions
3. "Connect Wallet" button visible in header area
4. Sonner Toaster is present in DOM (inspect element for toaster container)
5. wagmi.ts and constants.ts export all expected values
6. wagmi.ts uses `smartWalletOnly` preference (PAY-03: embedded wallet on first payment)
</verification>

<success_criteria>
- All payment dependencies installed (onchainkit, wagmi, viem, @tanstack/react-query, sonner, react-canvas-confetti)
- App wrapped in correct provider hierarchy (Wagmi > QueryClient > OnchainKit)
- Wallet connection button visible and functional
- USDC balance displayed when wallet connected
- Smart Wallet created on-demand via smartWalletOnly preference (PAY-03)
- Existing player functionality unaffected (no regressions)
- Build passes with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-payments-wallet/05-01-SUMMARY.md`
</output>
